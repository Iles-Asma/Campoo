{"version":3,"sources":["Exp.ts"],"names":["supportedPlatforms","determineEntryPoint","projectRoot","platform","projectConfig","includes","Error","platforms","entry","path","relative","sanitizedName","name","replace","normalize","escapeXMLCharacters","original","noAmps","noLt","noGt","noApos","Transformer","Minipass","constructor","config","settings","write","data","getNormalizedName","extension","end","replaced","toLowerCase","binaryExtensions","createFileTransform","transformFile","extname","undefined","extractAndPrepareTemplateAppAsync","templateSpec","extractTemplateAppAsync","expo","appFile","JsonFile","join","appJson","readAsync","writeAsync","packageFile","packageJson","private","version","description","tags","repository","_resolved","_integrity","_from","targetPath","pacote","tarball","stream","tarStream","extractTemplateAppAsyncImpl","cache","UserSettings","dotExpoHomeDirectory","fs","mkdirp","Promise","resolve","reject","extractStream","tar","x","cwd","strip","transform","onentry","type","test","basename","on","pipe","sendAsync","recipient","url_","allowUnauthed","user","UserManager","ensureLoggedInAsync","api","ApiV2","clientForUser","postAsync","emailOrPhone","url","includeExpoLinks","getProjectRandomnessAsync","ps","ProjectSettings","randomness","urlRandomness","resetProjectRandomnessAsync","UrlUtils","someRandomness","setAsync"],"mappings":"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","sourcesContent":["import { BareAppConfig, ExpoConfig, ProjectConfig } from '@expo/config';\nimport { getEntryPoint } from '@expo/config/paths';\nimport JsonFile from '@expo/json-file';\nimport fs from 'fs-extra';\nimport merge from 'lodash/merge';\nimport Minipass from 'minipass';\nimport pacote, { PackageSpec } from 'pacote';\nimport path from 'path';\nimport { Readable } from 'stream';\nimport tar, { ReadEntry } from 'tar';\n\nimport ApiV2 from './ApiV2';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as UrlUtils from './UrlUtils';\nimport UserManager from './User';\nimport UserSettings from './UserSettings';\n\ntype AppJsonInput = { expo: Partial<ExpoConfig> & { name: string } };\ntype TemplateConfig = { name: string };\n\nconst supportedPlatforms = ['ios', 'android', 'web'];\n\n/** @deprecated use getEntryPoint from @expo/config/paths */\nexport function determineEntryPoint(\n  projectRoot: string,\n  platform?: string,\n  projectConfig?: ProjectConfig\n): string {\n  if (platform && !supportedPlatforms.includes(platform)) {\n    throw new Error(\n      `Failed to resolve the project's entry file: The platform \"${platform}\" is not supported.`\n    );\n  }\n  // TODO: Bacon: support platform extension resolution like .ios, .native\n  // const platforms = [platform, 'native'].filter(Boolean) as string[];\n  const platforms: string[] = [];\n\n  const entry = getEntryPoint(projectRoot, ['./index'], platforms, projectConfig);\n  if (!entry)\n    throw new Error(\n      `The project entry file could not be resolved. Please either define it in the \\`package.json\\` (main), \\`app.json\\` (expo.entryPoint), create an \\`index.js\\`, or install the \\`expo\\` package.`\n    );\n\n  return path.relative(projectRoot, entry);\n}\n\nfunction sanitizedName(name: string) {\n  return name\n    .replace(/[\\W_]+/g, '')\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '');\n}\n\nfunction escapeXMLCharacters(original: string): string {\n  const noAmps = original.replace('&', '&amp;');\n  const noLt = noAmps.replace('<', '&lt;');\n  const noGt = noLt.replace('>', '&gt;');\n  const noApos = noGt.replace('\"', '\\\\\"');\n  return noApos.replace(\"'\", \"\\\\'\");\n}\n\nclass Transformer extends Minipass {\n  data = '';\n\n  constructor(public config: TemplateConfig, private settings: { extension: string }) {\n    super();\n  }\n\n  write(data: string) {\n    this.data += data;\n    return true;\n  }\n\n  getNormalizedName(): string {\n    if (['.xml', '.plist'].includes(this.settings.extension)) {\n      return escapeXMLCharacters(this.config.name);\n    }\n    return this.config.name;\n  }\n\n  end() {\n    const name = this.getNormalizedName();\n    const replaced = this.data\n      .replace(/Hello App Display Name/g, name)\n      .replace(/HelloWorld/g, sanitizedName(name))\n      .replace(/helloworld/g, sanitizedName(name.toLowerCase()));\n    super.write(replaced);\n    return super.end();\n  }\n}\n\n// Binary files, don't process these (avoid decoding as utf8)\nconst binaryExtensions = ['.png', '.jar', '.keystore', '.otf', '.ttf'];\n\nfunction createFileTransform(config: TemplateConfig) {\n  return function transformFile(entry: ReadEntry) {\n    const extension = path.extname(entry.path);\n    if (!binaryExtensions.includes(extension) && config.name) {\n      return new Transformer(config, { extension });\n    }\n    return undefined;\n  };\n}\n\n/**\n * Extract a template app to a given file path and clean up any properties left over from npm to\n * prepare it for usage.\n */\nexport async function extractAndPrepareTemplateAppAsync(\n  templateSpec: PackageSpec,\n  projectRoot: string,\n  config: AppJsonInput | BareAppConfig\n) {\n  await extractTemplateAppAsync(templateSpec, projectRoot, {\n    name: 'name' in config ? config.name : config.expo.name,\n  });\n\n  const appFile = new JsonFile(path.join(projectRoot, 'app.json'));\n  const appJson = merge(await appFile.readAsync(), config);\n  await appFile.writeAsync(appJson);\n\n  const packageFile = new JsonFile(path.join(projectRoot, 'package.json'));\n  let packageJson = await packageFile.readAsync();\n  // Adding `private` stops npm from complaining about missing `name` and `version` fields.\n  // We don't add a `name` field because it also exists in `app.json`.\n  packageJson = { ...packageJson, private: true };\n  // These are metadata fields related to the template package, let's remove them from the package.json.\n  delete packageJson.name;\n  delete packageJson.version;\n  delete packageJson.description;\n  delete packageJson.tags;\n  delete packageJson.repository;\n  // pacote adds these, but we don't want them in the package.json of the project.\n  delete packageJson._resolved;\n  delete packageJson._integrity;\n  delete packageJson._from;\n  await packageFile.writeAsync(packageJson);\n\n  return projectRoot;\n}\n\n/**\n * Extract a template app to a given file path.\n */\nexport async function extractTemplateAppAsync(\n  templateSpec: PackageSpec,\n  targetPath: string,\n  config: { name?: string }\n) {\n  await pacote.tarball.stream(\n    templateSpec,\n    tarStream => {\n      return extractTemplateAppAsyncImpl(targetPath, config, tarStream);\n    },\n    {\n      cache: path.join(UserSettings.dotExpoHomeDirectory(), 'template-cache'),\n    }\n  );\n\n  return targetPath;\n}\n\nasync function extractTemplateAppAsyncImpl(\n  targetPath: string,\n  config: { name?: string },\n  tarStream: Readable\n) {\n  await fs.mkdirp(targetPath);\n  await new Promise((resolve, reject) => {\n    const extractStream = tar.x({\n      cwd: targetPath,\n      strip: 1,\n      // TODO(ville): pending https://github.com/DefinitelyTyped/DefinitelyTyped/pull/36598\n      // @ts-ignore property missing from the type definition\n      transform: createFileTransform(config),\n      onentry(entry: ReadEntry) {\n        if (config.name) {\n          // Rewrite paths for bare workflow\n          entry.path = entry.path\n            .replace(\n              /HelloWorld/g,\n              entry.path.includes('android')\n                ? sanitizedName(config.name.toLowerCase())\n                : sanitizedName(config.name)\n            )\n            .replace(/helloworld/g, sanitizedName(config.name).toLowerCase());\n        }\n        if (entry.type && /^file$/i.test(entry.type) && path.basename(entry.path) === 'gitignore') {\n          // Rename `gitignore` because npm ignores files named `.gitignore` when publishing.\n          // See: https://github.com/npm/npm/issues/1862\n          entry.path = entry.path.replace(/gitignore$/, '.gitignore');\n        }\n      },\n    });\n    tarStream.on('error', reject);\n    extractStream.on('error', reject);\n    extractStream.on('close', resolve);\n    tarStream.pipe(extractStream);\n  });\n}\n\nexport async function sendAsync(recipient: string, url_: string, allowUnauthed: boolean = true) {\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('send-project', {\n    emailOrPhone: recipient,\n    url: url_,\n    includeExpoLinks: allowUnauthed,\n  });\n}\n\n// TODO: figure out where these functions should live\nexport async function getProjectRandomnessAsync(projectRoot: string) {\n  const ps = await ProjectSettings.readAsync(projectRoot);\n  const randomness = ps.urlRandomness;\n  if (randomness) {\n    return randomness;\n  } else {\n    return resetProjectRandomnessAsync(projectRoot);\n  }\n}\n\nexport async function resetProjectRandomnessAsync(projectRoot: string) {\n  const randomness = UrlUtils.someRandomness();\n  ProjectSettings.setAsync(projectRoot, { urlRandomness: randomness });\n  return randomness;\n}\n"],"file":"../Exp.js","sourceRoot":"/@expo/xdl@59.0.19/src"}