{"version":3,"sources":["Project.ts"],"names":["MINIMUM_BUNDLE_SIZE","treekillAsync","treekill","bundlePlatforms","currentStatus","projectDir","packagerPort","expoServerPort","ProjectSettings","readPackagerInfoAsync","_getFreePortAsync","rangeStart","port","hostnames","XDLError","_requireFromProject","modulePath","projectRoot","exp","fullPath","require","e","getLatestReleaseAsync","options","user","UserManager","ensureLoggedInAsync","api","ApiV2","clientForUser","skipSDKVersionRequirement","result","postAsync","owner","slug","releaseChannel","count","platform","queryResult","length","isSelfHostedIndex","obj","sdkVersion","mergeAppDistributions","sourceDirs","outputDir","assetPathToWrite","path","resolve","fs","ensureDir","bundlesPathToWrite","androidIndexes","iosIndexes","sourceDir","promises","sourceAssetDir","outputAssetDir","assetPromise","copy","push","sourceBundleDir","outputBundleDir","bundlePromise","Promise","all","putJsonInMemory","indexPath","accumulator","index","JsonFile","readAsync","Array","isArray","androidIndexPath","iosIndexPath","getSortedIndex","indexes","sort","index1","index2","semver","eq","logger","global","error","gte","sortedAndroidIndexes","sortedIosIndexes","join","JSON","stringify","prepareHooks","hooks","hookType","validHooks","forEach","hook","file","fn","_fn","undefined","runHook","hookOptions","config","then","info","quiet","shouldUseDevServer","Versions","gteSdkVersion","getenv","boolish","exportAppAsync","publicUrl","assetUrl","experimentalBundle","absoluteOutputDir","process","cwd","defaultTarget","target","publishOptions","pkg","_getPublishExpConfigAsync","bundles","buildPublishBundlesAsync","dev","isDev","useDevServer","iosBundle","ios","code","androidBundle","android","iosBundleHash","crypto","createHash","update","digest","iosBundleUrl","iosJsPath","androidBundleHash","androidBundleUrl","androidJsPath","relativeBundlePaths","assets","hostedUrl","assetPath","fileMetadata","asset","fileHashes","map","hash","ext","type","bundle","metadata","version","bundler","writeFileSync","dumpAssetmap","assetmap","iosSourceMap","androidSourceMap","dumpSourcemap","iosMapName","iosMapPath","androidMapName","androidMapPath","lt","truncateLastNLines","appendFile","debugHtml","validPostExportHooks","assetUrlOverride","publishedTime","Date","toISOString","commitTime","releaseId","uuid","v4","hashIds","HashIds","v1","revisionId","encode","now","developer","tool","username","getCurrentUsernameAsync","ANONYMOUS_USERNAME","id","androidManifest","bundleUrl","dependencies","Object","keys","iosManifest","url","log","msg","warn","stack","EmbeddedAssets","configureAsync","iosManifestUrl","androidManifestUrl","filePath","n","lines","readLastLines","read","to_vanquish","size","stat","truncate","findReusableBuildAsync","getCurrentUserAsync","buildReuseStatus","publishAsync","Analytics","logEvent","developerTool","Config","validationStatus","Doctor","validateWithNetworkAsync","ERROR","FATAL","isKernel","kind","validPostPublishHooks","files","chalk","dim","TableText","createFilesTable","hasHooks","shouldPublishAndroidMaps","publishSourceMapPath","shouldPublishIosMaps","response","_uploadArtifactsAsync","serverError","Error","Sentry","captureException","publishManifestPath","shouldEmbedAssetsForExpoUpdates","ExponentTools","getManifestAsync","Accept","fullManifestUrl","replace","_handleKernelPublishedAsync","formData","FormData","append","uploadFormDataAsync","privateExp","isPublicConfig","locales","getResolvedLocalesAsync","bundleOptions","startReactNativeServerAsync","nonPersistent","maxWorkers","reset","resetCache","verbose","fetchPublishBundlesAsync","stopReactNativeServerAsync","platforms","ProjectUtils","getLogger","entryPoint","Exp","determineEntryPoint","opts","publishUrl","UrlUtils","constructPublishUrlAsync","sourceMapUrl","constructSourceMapUrlAsync","assetsUrl","constructAssetsUrlAsync","_getForPlatformAsync","errorCode","minLength","iosAssetsJson","androidAssetsJson","parse","fullUrl","axios","request","responseType","transformResponse","data","proxy","validateStatus","status","headers","body","logError","message","kernelBundleUrl","scheme","host","kernel","androidManifestPath","manifest","writeFile","iosManifestPath","getConfigAsync","configName","configPrefix","ThirdParty","getManifest","_validateManifest","bundleIdentifier","package","_validateOptions","schema","joi","object","current","boolean","mode","string","any","valid","expIds","array","regex","strict","validate","toString","_getExpAsync","name","toLowerCase","getBuildStatusAsync","startBuildAsync","putAsync","_waitForRunningAsync","retries","test","METRO_VERBOSE_WARNING","NODE_12_WINDOWS_METRO_ERROR","NODE_12_WINDOWS_METRO_SUGGESTION","_logPackagerOutput","level","output","_isIgnorableDuplicateModuleWarning","logDebug","_isIgnorableMetroConsoleOutput","_isIgnorableRnpmWarning","includes","logInfo","startsWith","reactNativeNodeModulesPath","reactNativeNodeModulesPattern","reactNativeNodeModulesCollisionRegex","RegExp","_isIgnorableBugReportingExtraData","_isAppRegistryStartupMessage","_handleDeviceLogs","deviceId","deviceName","logs","i","args","logLevel","tag","groupDepth","shouldHide","includesStack","Watchman","addToPathAsync","unblockAndGetVersionAsync","customLogReporterPath","__dirname","sourceExtsConfig","isTS","isReact","isModern","sourceExts","packagerOpts","lteSdkVersion","assetPlugins","userPackagerOpts","userSourceExts","Set","cliOpts","key","val","entries","env","EXPO_DEBUG","defaultCliPath","cliPath","rnCliPath","nodePath","_nodePathForProjectRoot","nodePathEnv","NODE_PATH","packagerProcess","child_process","fork","NODE_OPTIONS","METRO_NODE_OPTIONS","REACT_NATIVE_APP_ROOT","ELECTRON_RUN_AS_NODE","silent","setPackagerInfoAsync","packagerPid","pid","on","stdout","stderr","setEncoding","pipe","exitPromise","reject","once","packagerUrl","constructBundleUrlAsync","urlType","hostType","race","paths","directory","parentDirectory","dirname","delimiter","packagerInfo","startExpoServerAsync","stopExpoServerAsync","app","use","express","json","limit","urlencoded","extended","ConnectionStatus","isOffline","validateWithoutNetworkAsync","manifestHandler","get","post","req","res","send","server","close","expRc","manifestPort","listen","address","method","startDevServerAsync","startOptions","EXPO_TARGET","middleware","setOptionsAsync","Number","isInteger","startAsync","webOnly","Webpack","restartAsync","DevSession","startSession","devClient","offline","_stopInternalAsync","stopSession","stopAsync","Android","maybeStopAdbDaemonAsync","stopWebOnlyAsync","setTimeout","ngrokPid","kill","expoServerNgrokUrl","packagerNgrokUrl","webpackServerPort"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAeA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAEA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;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","sourcesContent":["import {\n  configFilename,\n  ExpoAppManifest,\n  ExpoConfig,\n  getConfig,\n  getDefaultTarget,\n  Hook,\n  HookArguments,\n  HookType,\n  PackageJSONConfig,\n  Platform,\n  ProjectTarget,\n  readExpRcAsync,\n  resolveModule,\n} from '@expo/config';\nimport { getBareExtensions, getManagedExtensions } from '@expo/config/paths';\nimport { bundleAsync, MetroDevServerOptions, runMetroDevServerAsync } from '@expo/dev-server';\nimport JsonFile from '@expo/json-file';\nimport joi from '@hapi/joi';\nimport assert from 'assert';\nimport axios from 'axios';\nimport chalk from 'chalk';\nimport child_process from 'child_process';\nimport crypto from 'crypto';\nimport decache from 'decache';\nimport delayAsync from 'delay-async';\nimport express from 'express';\nimport freeportAsync from 'freeport-async';\nimport fs from 'fs-extra';\nimport getenv from 'getenv';\nimport HashIds from 'hashids';\nimport escapeRegExp from 'lodash/escapeRegExp';\nimport { AddressInfo } from 'net';\nimport path from 'path';\nimport readLastLines from 'read-last-lines';\nimport semver from 'semver';\nimport slug from 'slugify';\nimport split from 'split';\nimport treekill from 'tree-kill';\nimport urljoin from 'url-join';\nimport { promisify } from 'util';\nimport uuid from 'uuid';\n\nimport Analytics from './Analytics';\nimport * as Android from './Android';\nimport ApiV2 from './ApiV2';\nimport Config from './Config';\nimport * as ConnectionStatus from './ConnectionStatus';\nimport * as DevSession from './DevSession';\nimport * as EmbeddedAssets from './EmbeddedAssets';\nimport { maySkipManifestValidation } from './Env';\nimport { ErrorCode } from './ErrorCode';\nimport * as Exp from './Exp';\nimport logger from './Logger';\nimport { Asset, exportAssetsAsync, publishAssetsAsync } from './ProjectAssets';\nimport * as ProjectSettings from './ProjectSettings';\nimport * as Sentry from './Sentry';\nimport * as ThirdParty from './ThirdParty';\nimport * as UrlUtils from './UrlUtils';\nimport UserManager, { ANONYMOUS_USERNAME, User } from './User';\nimport * as Versions from './Versions';\nimport * as Watchman from './Watchman';\nimport * as Webpack from './Webpack';\nimport XDLError from './XDLError';\nimport * as ExponentTools from './detach/ExponentTools';\nimport * as TableText from './logs/TableText';\nimport { learnMore } from './logs/TerminalLink';\nimport * as Doctor from './project/Doctor';\nimport { getManifestHandler } from './project/ManifestHandler';\nimport * as ProjectUtils from './project/ProjectUtils';\nimport { assertValidProjectRoot } from './project/errors';\nimport { startTunnelsAsync, stopTunnelsAsync } from './project/ngrok';\nimport { writeArtifactSafelyAsync } from './tools/ArtifactUtils';\nimport FormData from './tools/FormData';\nconst MINIMUM_BUNDLE_SIZE = 500;\n\nconst treekillAsync = promisify<number, string>(treekill);\n\ntype SelfHostedIndex = ExpoAppManifest & {\n  dependencies: string[];\n};\n\ntype LoadedHook = Hook & {\n  _fn: (input: HookArguments) => any;\n};\n\nexport type StartOptions = {\n  devClient?: boolean;\n  reset?: boolean;\n  nonInteractive?: boolean;\n  nonPersistent?: boolean;\n  maxWorkers?: number;\n  webOnly?: boolean;\n  target?: ProjectTarget;\n};\n\ntype PublishOptions = {\n  releaseChannel?: string;\n  target?: ProjectTarget;\n  resetCache?: boolean;\n  maxWorkers?: number;\n  quiet?: boolean;\n};\n\ntype PackagerOptions = {\n  dev: boolean;\n  minify: boolean;\n};\n\ntype Release = {\n  fullName: string;\n  channel: string;\n  channelId: string;\n  publicationId: string;\n  appVersion: string;\n  sdkVersion: string;\n  publishedTime: string;\n  platform: string;\n};\n\ntype ProjectStatus = 'running' | 'ill' | 'exited';\n\ntype BundlePlatform = 'android' | 'ios';\n\ntype PlatformMetadata = { bundle: string; assets: { path: string; ext: string }[] };\n\ntype FileMetadata = {\n  [key in BundlePlatform]: PlatformMetadata;\n};\n\ntype Metadata = {\n  version: 0;\n  bundler: 'metro';\n  fileMetadata: FileMetadata;\n};\n\nconst bundlePlatforms: BundlePlatform[] = ['android', 'ios'];\n\nexport async function currentStatus(projectDir: string): Promise<ProjectStatus> {\n  const { packagerPort, expoServerPort } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n  if (packagerPort && expoServerPort) {\n    return 'running';\n  } else if (packagerPort || expoServerPort) {\n    return 'ill';\n  } else {\n    return 'exited';\n  }\n}\n\nasync function _getFreePortAsync(rangeStart: number) {\n  const port = await freeportAsync(rangeStart, { hostnames: [null, 'localhost'] });\n  if (!port) {\n    throw new XDLError('NO_PORT_FOUND', 'No available port found');\n  }\n\n  return port;\n}\n\nfunction _requireFromProject(modulePath: string, projectRoot: string, exp: ExpoConfig) {\n  try {\n    const fullPath = resolveModule(modulePath, projectRoot, exp);\n    // Clear the require cache for this module so get a fresh version of it\n    // without requiring the user to restart Expo CLI\n    decache(fullPath);\n    // $FlowIssue: doesn't work with dynamic requires\n    return require(fullPath);\n  } catch (e) {\n    return null;\n  }\n}\n\nexport async function getLatestReleaseAsync(\n  projectRoot: string,\n  options: {\n    releaseChannel: string;\n    platform: string;\n    owner?: string;\n  }\n): Promise<Release | null> {\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n  const { exp } = getConfig(projectRoot, { skipSDKVersionRequirement: true });\n  const result = await api.postAsync('publish/history', {\n    owner: options.owner,\n    slug: exp.slug,\n    releaseChannel: options.releaseChannel,\n    count: 1,\n    platform: options.platform,\n  });\n  const { queryResult } = result;\n  if (queryResult && queryResult.length > 0) {\n    return queryResult[0];\n  } else {\n    return null;\n  }\n}\n\nfunction isSelfHostedIndex(obj: any): obj is SelfHostedIndex {\n  return !!obj.sdkVersion;\n}\n\n// Takes multiple exported apps in sourceDirs and coalesces them to one app in outputDir\nexport async function mergeAppDistributions(\n  projectRoot: string,\n  sourceDirs: string[],\n  outputDir: string\n): Promise<void> {\n  const assetPathToWrite = path.resolve(projectRoot, outputDir, 'assets');\n  await fs.ensureDir(assetPathToWrite);\n  const bundlesPathToWrite = path.resolve(projectRoot, outputDir, 'bundles');\n  await fs.ensureDir(bundlesPathToWrite);\n\n  // merge files from bundles and assets\n  const androidIndexes: SelfHostedIndex[] = [];\n  const iosIndexes: SelfHostedIndex[] = [];\n\n  for (const sourceDir of sourceDirs) {\n    const promises = [];\n\n    // copy over assets/bundles from other src dirs to the output dir\n    if (sourceDir !== outputDir) {\n      // copy file over to assetPath\n      const sourceAssetDir = path.resolve(projectRoot, sourceDir, 'assets');\n      const outputAssetDir = path.resolve(projectRoot, outputDir, 'assets');\n      const assetPromise = fs.copy(sourceAssetDir, outputAssetDir);\n      promises.push(assetPromise);\n\n      // copy files over to bundlePath\n      const sourceBundleDir = path.resolve(projectRoot, sourceDir, 'bundles');\n      const outputBundleDir = path.resolve(projectRoot, outputDir, 'bundles');\n      const bundlePromise = fs.copy(sourceBundleDir, outputBundleDir);\n      promises.push(bundlePromise);\n\n      await Promise.all(promises);\n    }\n\n    // put index.jsons into memory\n    const putJsonInMemory = async (indexPath: string, accumulator: SelfHostedIndex[]) => {\n      const index = await JsonFile.readAsync(indexPath);\n\n      if (!isSelfHostedIndex(index)) {\n        throw new XDLError(\n          'INVALID_MANIFEST',\n          `Invalid index.json, must specify an sdkVersion at ${indexPath}`\n        );\n      }\n      if (Array.isArray(index)) {\n        // index.json could also be an array\n        accumulator.push(...index);\n      } else {\n        accumulator.push(index);\n      }\n    };\n\n    const androidIndexPath = path.resolve(projectRoot, sourceDir, 'android-index.json');\n    await putJsonInMemory(androidIndexPath, androidIndexes);\n\n    const iosIndexPath = path.resolve(projectRoot, sourceDir, 'ios-index.json');\n    await putJsonInMemory(iosIndexPath, iosIndexes);\n  }\n\n  // sort indexes by descending sdk value\n  const getSortedIndex = (indexes: SelfHostedIndex[]) => {\n    return indexes.sort((index1: SelfHostedIndex, index2: SelfHostedIndex) => {\n      if (semver.eq(index1.sdkVersion, index2.sdkVersion)) {\n        logger.global.error(\n          `Encountered multiple index.json with the same SDK version ${index1.sdkVersion}. This could result in undefined behavior.`\n        );\n      }\n      return semver.gte(index1.sdkVersion, index2.sdkVersion) ? -1 : 1;\n    });\n  };\n\n  const sortedAndroidIndexes = getSortedIndex(androidIndexes);\n  const sortedIosIndexes = getSortedIndex(iosIndexes);\n\n  // Save the json arrays to disk\n  await writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'android-index.json'),\n    JSON.stringify(sortedAndroidIndexes)\n  );\n\n  await writeArtifactSafelyAsync(\n    projectRoot,\n    null,\n    path.join(outputDir, 'ios-index.json'),\n    JSON.stringify(sortedIosIndexes)\n  );\n}\n\nfunction prepareHooks(\n  hooks: ExpoConfig['hooks'],\n  hookType: HookType,\n  projectRoot: string,\n  exp: ExpoConfig\n) {\n  const validHooks: LoadedHook[] = [];\n\n  if (hooks) {\n    if (hooks[hookType]) {\n      hooks[hookType]!.forEach((hook: any) => {\n        const { file } = hook;\n        const fn = _requireFromProject(file, projectRoot, exp);\n        if (typeof fn !== 'function') {\n          logger.global.error(\n            `Unable to load ${hookType} hook: '${file}'. The module does not export a function.`\n          );\n        } else {\n          hook._fn = fn;\n          validHooks.push(hook);\n        }\n      });\n    }\n\n    if (hooks[hookType] !== undefined && validHooks.length !== hooks[hookType]?.length) {\n      throw new XDLError(\n        'HOOK_INITIALIZATION_ERROR',\n        `Please fix your ${hookType} hook configuration`\n      );\n    }\n  }\n\n  return validHooks;\n}\n\nexport async function runHook(hook: LoadedHook, hookOptions: Omit<HookArguments, 'config'>) {\n  let result = hook._fn({\n    config: hook.config,\n    ...hookOptions,\n  });\n\n  // If it's a promise, wait for it to resolve\n  if (result && result.then) {\n    result = await result;\n  }\n\n  if (result) {\n    logger.global.info({ quiet: true }, result);\n  }\n}\n\n/**\n * Returns true if we should use Metro using its JS APIs via @expo/dev-server (the modern and fast\n * way), false if we should fall back to spawning it as a subprocess (supported for backwards\n * compatibility with SDK39 and older).\n */\nfunction shouldUseDevServer(exp: ExpoConfig) {\n  return Versions.gteSdkVersion(exp, '40.0.0') || getenv.boolish('EXPO_USE_DEV_SERVER', false);\n}\n\n/**\n * If the `eas` flag is true, the stucture of the outputDir will be:\n assets\n    *\n bundles\n    android-01ee6e3ab3e8c16a4d926c91808d5320.js\n    ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n metadata.json\n\n * If the `eas` flag is not true, then this function is for self hosting \n * and the outputDir will have the files created in the project directory the following way:\n.\n android-index.json\n ios-index.json\n assets\n    1eccbc4c41d49fd81840aef3eaabe862\n bundles\n       android-01ee6e3ab3e8c16a4d926c91808d5320.js\n       ios-ee8206cc754d3f7aa9123b7f909d94ea.js\n */\nexport async function exportAppAsync(\n  projectRoot: string,\n  publicUrl: string,\n  assetUrl: string,\n  outputDir: string,\n  options: {\n    isDev?: boolean;\n    dumpAssetmap?: boolean;\n    dumpSourcemap?: boolean;\n    publishOptions?: PublishOptions;\n  } = {},\n  experimentalBundle: boolean\n): Promise<void> {\n  const absoluteOutputDir = path.resolve(process.cwd(), outputDir);\n  const defaultTarget = getDefaultTarget(projectRoot);\n  const target = options.publishOptions?.target ?? defaultTarget;\n\n  // build the bundles\n  // make output dirs if not exists\n  const assetPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'assets'));\n  await fs.ensureDir(assetPathToWrite);\n  const bundlesPathToWrite = path.resolve(projectRoot, path.join(outputDir, 'bundles'));\n  await fs.ensureDir(bundlesPathToWrite);\n\n  const { exp, pkg, hooks } = await _getPublishExpConfigAsync(\n    projectRoot,\n    options.publishOptions || {}\n  );\n\n  const bundles = await buildPublishBundlesAsync(projectRoot, options.publishOptions, {\n    dev: options.isDev,\n    useDevServer: shouldUseDevServer(exp),\n  });\n  const iosBundle = bundles.ios.code;\n  const androidBundle = bundles.android.code;\n\n  const iosBundleHash = crypto.createHash('md5').update(iosBundle).digest('hex');\n  const iosBundleUrl = `ios-${iosBundleHash}.js`;\n  const iosJsPath = path.join(absoluteOutputDir, 'bundles', iosBundleUrl);\n\n  const androidBundleHash = crypto.createHash('md5').update(androidBundle).digest('hex');\n  const androidBundleUrl = `android-${androidBundleHash}.js`;\n  const androidJsPath = path.join(absoluteOutputDir, 'bundles', androidBundleUrl);\n\n  const relativeBundlePaths = {\n    android: path.join('bundles', androidBundleUrl),\n    ios: path.join('bundles', iosBundleUrl),\n  };\n\n  await writeArtifactSafelyAsync(projectRoot, null, iosJsPath, iosBundle);\n  await writeArtifactSafelyAsync(projectRoot, null, androidJsPath, androidBundle);\n\n  logger.global.info('Finished saving JS Bundles.');\n\n  const { assets } = await exportAssetsAsync({\n    projectRoot,\n    exp,\n    hostedUrl: publicUrl,\n    assetPath: 'assets',\n    outputDir: absoluteOutputDir,\n    bundles,\n    experimentalBundle,\n  });\n\n  if (experimentalBundle) {\n    // Build metadata.json\n    const fileMetadata: {\n      [key in BundlePlatform]: Partial<PlatformMetadata>;\n    } = { android: {}, ios: {} };\n    bundlePlatforms.forEach(platform => {\n      fileMetadata[platform].assets = [];\n      bundles[platform].assets.forEach((asset: { type: string; fileHashes: string[] }) => {\n        fileMetadata[platform].assets = [\n          ...fileMetadata[platform].assets!,\n          ...asset.fileHashes.map(hash => {\n            return { path: path.join('assets', hash), ext: asset.type };\n          }),\n        ];\n      });\n      fileMetadata[platform].bundle = relativeBundlePaths[platform];\n    });\n    const metadata: Metadata = {\n      version: 0,\n      bundler: 'metro',\n      fileMetadata: fileMetadata as FileMetadata,\n    };\n\n    fs.writeFileSync(path.resolve(outputDir, 'metadata.json'), JSON.stringify(metadata));\n  }\n\n  if (options.dumpAssetmap) {\n    logger.global.info('Dumping asset map.');\n\n    const assetmap: { [hash: string]: Asset } = {};\n\n    assets.forEach((asset: Asset) => {\n      assetmap[asset.hash] = asset;\n    });\n\n    await writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(absoluteOutputDir, 'assetmap.json'),\n      JSON.stringify(assetmap)\n    );\n  }\n\n  const iosSourceMap = bundles.ios.map;\n  const androidSourceMap = bundles.android.map;\n\n  // build source maps\n  if (options.dumpSourcemap) {\n    // write the sourcemap files\n    const iosMapName = `ios-${iosBundleHash}.map`;\n    const iosMapPath = path.join(absoluteOutputDir, 'bundles', iosMapName);\n    await writeArtifactSafelyAsync(projectRoot, null, iosMapPath, iosSourceMap);\n\n    const androidMapName = `android-${androidBundleHash}.map`;\n    const androidMapPath = path.join(absoluteOutputDir, 'bundles', androidMapName);\n    await writeArtifactSafelyAsync(projectRoot, null, androidMapPath, androidSourceMap);\n\n    if (target === 'managed' && semver.lt(exp.sdkVersion, '40.0.0')) {\n      // Remove original mapping to incorrect sourcemap paths\n      // In SDK 40+ and bare projects, we no longer need to do this.\n      logger.global.info('Configuring source maps');\n      await truncateLastNLines(iosJsPath, 1);\n      await truncateLastNLines(androidJsPath, 1);\n    }\n\n    // Add correct mapping to sourcemap paths\n    await fs.appendFile(iosJsPath, `\\n//# sourceMappingURL=${iosMapName}`);\n    await fs.appendFile(androidJsPath, `\\n//# sourceMappingURL=${androidMapName}`);\n\n    // Make a debug html so user can debug their bundles\n    logger.global.info('Preparing additional debugging files');\n    const debugHtml = `\n    <script src=\"${urljoin('bundles', iosBundleUrl)}\"></script>\n    <script src=\"${urljoin('bundles', androidBundleUrl)}\"></script>\n    Open up this file in Chrome. In the Javascript developer console, navigate to the Source tab.\n    You can see a red coloured folder containing the original source code from your bundle.\n    `;\n\n    await writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(absoluteOutputDir, 'debug.html'),\n      debugHtml\n    );\n  }\n\n  // Skip the hooks and manifest creation if building for EAS.\n  if (!experimentalBundle) {\n    const validPostExportHooks = prepareHooks(hooks, 'postExport', projectRoot, exp);\n\n    // Add assetUrl to manifest\n    exp.assetUrlOverride = assetUrl;\n\n    exp.publishedTime = new Date().toISOString();\n    exp.commitTime = new Date().toISOString();\n    exp.releaseId = uuid.v4();\n\n    // generate revisionId and id the same way www does\n    const hashIds = new HashIds(uuid.v1(), 10);\n    exp.revisionId = hashIds.encode(Date.now());\n\n    if (options.isDev) {\n      exp.developer = {\n        tool: 'exp',\n      };\n    }\n\n    if (!exp.slug) {\n      throw new XDLError('INVALID_MANIFEST', 'Must provide a slug field in the app.json manifest.');\n    }\n\n    let username = await UserManager.getCurrentUsernameAsync();\n\n    if (!username) {\n      username = ANONYMOUS_USERNAME;\n    }\n\n    exp.id = `@${username}/${exp.slug}`;\n\n    // save the android manifest\n    const androidManifest = {\n      ...exp,\n      bundleUrl: urljoin(publicUrl, 'bundles', androidBundleUrl),\n      platform: 'android',\n      dependencies: Object.keys(pkg.dependencies),\n    };\n\n    await writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(absoluteOutputDir, 'android-index.json'),\n      JSON.stringify(androidManifest)\n    );\n\n    // save the ios manifest\n    const iosManifest = {\n      ...exp,\n      bundleUrl: urljoin(publicUrl, 'bundles', iosBundleUrl),\n      platform: 'ios',\n      dependencies: Object.keys(pkg.dependencies),\n    };\n\n    await writeArtifactSafelyAsync(\n      projectRoot,\n      null,\n      path.join(absoluteOutputDir, 'ios-index.json'),\n      JSON.stringify(iosManifest)\n    );\n\n    assert(androidManifest!, 'should have been assigned');\n    assert(iosManifest!, 'should have been assigned');\n    const hookOptions = {\n      url: null,\n      exp,\n      iosBundle,\n      iosSourceMap,\n      iosManifest,\n      androidBundle,\n      androidSourceMap,\n      androidManifest,\n      projectRoot,\n      log: (msg: any) => {\n        logger.global.info({ quiet: true }, msg);\n      },\n    };\n\n    for (const hook of validPostExportHooks) {\n      logger.global.info(`Running postExport hook: ${hook.file}`);\n\n      try {\n        runHook(hook, hookOptions);\n      } catch (e) {\n        logger.global.warn(`Warning: postExport hook '${hook.file}' failed: ${e.stack}`);\n      }\n    }\n\n    // configure embedded assets for expo-updates or ExpoKit\n    await EmbeddedAssets.configureAsync({\n      projectRoot,\n      pkg,\n      exp,\n      iosManifestUrl: urljoin(publicUrl, 'ios-index.json'),\n      iosManifest,\n      iosBundle,\n      iosSourceMap,\n      androidManifestUrl: urljoin(publicUrl, 'android-index.json'),\n      androidManifest,\n      androidBundle,\n      androidSourceMap,\n      target,\n    });\n  }\n}\n\n// truncate the last n lines in a file\nasync function truncateLastNLines(filePath: string, n: number) {\n  const lines = await readLastLines.read(filePath, n);\n  const to_vanquish = lines.length;\n  const { size } = await fs.stat(filePath);\n  await fs.truncate(filePath, size - to_vanquish);\n}\n\nexport async function findReusableBuildAsync(\n  releaseChannel: string,\n  platform: string,\n  sdkVersion: string,\n  slug: string,\n  owner?: string\n): Promise<{ downloadUrl?: string; canReuse: boolean }> {\n  const user = await UserManager.getCurrentUserAsync();\n\n  const buildReuseStatus = await ApiV2.clientForUser(user).postAsync('standalone-build/reuse', {\n    releaseChannel,\n    platform,\n    sdkVersion,\n    slug,\n    owner,\n  });\n\n  return buildReuseStatus;\n}\n\nexport interface PublishedProjectResult {\n  /**\n   * Project manifest URL\n   */\n  url: string;\n  /**\n   * TODO: What is this?\n   */\n  ids: string[];\n  /**\n   * TODO: What is this? Where does it come from?\n   */\n  err?: string;\n}\n\nexport async function publishAsync(\n  projectRoot: string,\n  options: PublishOptions = {}\n): Promise<PublishedProjectResult> {\n  options.target = options.target ?? getDefaultTarget(projectRoot);\n  const target = options.target;\n  const user = await UserManager.ensureLoggedInAsync();\n\n  Analytics.logEvent('Publish', {\n    projectRoot,\n    developerTool: Config.developerTool,\n  });\n\n  const validationStatus = await Doctor.validateWithNetworkAsync(projectRoot);\n  if (validationStatus === Doctor.ERROR || validationStatus === Doctor.FATAL) {\n    throw new XDLError(\n      'PUBLISH_VALIDATION_ERROR',\n      \"Couldn't publish because errors were found. (See logs above.) Please fix the errors and try again.\"\n    );\n  }\n\n  // Get project config\n  const { exp, pkg, hooks } = await _getPublishExpConfigAsync(projectRoot, options);\n\n  // Exit early if kernel builds are created with robot users\n  if (exp.isKernel && user.kind === 'robot') {\n    throw new XDLError('ROBOT_ACCOUNT_ERROR', 'Kernel builds are not available for robot users');\n  }\n\n  // TODO: refactor this out to a function, throw error if length doesn't match\n  const validPostPublishHooks: LoadedHook[] = prepareHooks(hooks, 'postPublish', projectRoot, exp);\n  const bundles = await buildPublishBundlesAsync(projectRoot, options, {\n    useDevServer: shouldUseDevServer(exp),\n  });\n  const androidBundle = bundles.android.code;\n  const iosBundle = bundles.ios.code;\n\n  const files = [\n    ['index.ios.js', bundles.ios.code],\n    ['index.android.js', bundles.android.code],\n  ];\n  // Account for inline source maps\n  if (bundles.ios.map) {\n    files.push([chalk.dim('index.ios.js.map'), bundles.ios.map]);\n  }\n  if (bundles.android.map) {\n    files.push([chalk.dim('index.android.js.map'), bundles.android.map]);\n  }\n\n  logger.global.info('');\n  logger.global.info(TableText.createFilesTable(files));\n  logger.global.info('');\n  logger.global.info(\n    ` JavaScript bundle sizes affect startup time. ${chalk.dim(\n      learnMore(`https://expo.fyi/javascript-bundle-sizes`)\n    )}`\n  );\n  logger.global.info('');\n\n  await publishAssetsAsync({ projectRoot, exp, bundles });\n\n  const hasHooks = validPostPublishHooks.length > 0;\n\n  const shouldPublishAndroidMaps = !!exp.android && !!exp.android.publishSourceMapPath;\n  const shouldPublishIosMaps = !!exp.ios && !!exp.ios.publishSourceMapPath;\n  const androidSourceMap = hasHooks || shouldPublishAndroidMaps ? bundles.android.map : null;\n  const iosSourceMap = hasHooks || shouldPublishIosMaps ? bundles.ios.map : null;\n\n  let response;\n  try {\n    response = await _uploadArtifactsAsync({\n      pkg,\n      exp,\n      iosBundle,\n      androidBundle,\n      options,\n    });\n  } catch (e) {\n    if (e.serverError === 'SCHEMA_VALIDATION_ERROR') {\n      throw new Error(\n        `There was an error validating your project schema. Check for any warnings about the contents of your app.json or app.config.js.`\n      );\n    }\n    Sentry.captureException(e);\n    throw e;\n  }\n\n  let androidManifest = {};\n  let iosManifest = {};\n\n  if (\n    validPostPublishHooks.length ||\n    (exp.ios && exp.ios.publishManifestPath) ||\n    (exp.android && exp.android.publishManifestPath) ||\n    EmbeddedAssets.shouldEmbedAssetsForExpoUpdates(projectRoot, exp, pkg, target)\n  ) {\n    [androidManifest, iosManifest] = await Promise.all([\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'android',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n      ExponentTools.getManifestAsync(response.url, {\n        'Exponent-SDK-Version': exp.sdkVersion,\n        'Exponent-Platform': 'ios',\n        'Expo-Release-Channel': options.releaseChannel,\n        Accept: 'application/expo+json,application/json',\n      }),\n    ]);\n\n    const hookOptions = {\n      url: response.url,\n      exp,\n      iosBundle,\n      iosSourceMap,\n      iosManifest,\n      androidBundle,\n      androidSourceMap,\n      androidManifest,\n      projectRoot,\n      log: (msg: any) => {\n        logger.global.info({ quiet: true }, msg);\n      },\n    };\n\n    for (const hook of validPostPublishHooks) {\n      logger.global.info(`Running postPublish hook: ${hook.file}`);\n      try {\n        runHook(hook, hookOptions);\n      } catch (e) {\n        logger.global.warn(`Warning: postPublish hook '${hook.file}' failed: ${e.stack}`);\n      }\n    }\n  }\n\n  const fullManifestUrl = response.url.replace('exp://', 'https://');\n  await EmbeddedAssets.configureAsync({\n    projectRoot,\n    pkg,\n    exp,\n    releaseChannel: options.releaseChannel ?? 'default',\n    iosManifestUrl: fullManifestUrl,\n    iosManifest,\n    iosBundle,\n    iosSourceMap,\n    androidManifestUrl: fullManifestUrl,\n    androidManifest,\n    androidBundle,\n    androidSourceMap,\n    target,\n  });\n\n  // TODO: move to postPublish hook\n  // This method throws early when a robot account is used for a kernel build\n  if (exp.isKernel && user.kind !== 'robot') {\n    await _handleKernelPublishedAsync({\n      user,\n      exp,\n      projectRoot,\n      url: response.url,\n    });\n  }\n\n  return {\n    ...response,\n    url:\n      options.releaseChannel && options.releaseChannel !== 'default'\n        ? `${response.url}?release-channel=${options.releaseChannel}`\n        : response.url,\n  };\n}\n\nasync function _uploadArtifactsAsync({\n  exp,\n  iosBundle,\n  androidBundle,\n  options,\n  pkg,\n}: {\n  exp: ExpoConfig;\n  iosBundle: string;\n  androidBundle: string;\n  options: PublishOptions;\n  pkg: PackageJSONConfig;\n}) {\n  logger.global.info('');\n  logger.global.info('Uploading JavaScript bundles');\n  const formData = new FormData();\n\n  formData.append('expJson', JSON.stringify(exp));\n  formData.append('packageJson', JSON.stringify(pkg));\n  formData.append('iosBundle', iosBundle, 'iosBundle');\n  formData.append('androidBundle', androidBundle, 'androidBundle');\n  formData.append('options', JSON.stringify(options));\n\n  const user = await UserManager.ensureLoggedInAsync();\n  const api = ApiV2.clientForUser(user);\n\n  return await api.uploadFormDataAsync('publish/new', formData);\n}\n\nasync function _getPublishExpConfigAsync(\n  projectRoot: string,\n  options: PublishOptions\n): Promise<{\n  exp: ExpoAppManifest;\n  pkg: PackageJSONConfig;\n  hooks: ExpoConfig['hooks'];\n}> {\n  if (options.releaseChannel != null && typeof options.releaseChannel !== 'string') {\n    throw new XDLError('INVALID_OPTIONS', 'releaseChannel must be a string');\n  }\n  options.releaseChannel = options.releaseChannel || 'default';\n\n  // Verify that exp/app.json and package.json exist\n  const { exp: privateExp } = getConfig(projectRoot);\n  const { hooks } = privateExp;\n  const { exp, pkg } = getConfig(projectRoot, { isPublicConfig: true });\n\n  const { sdkVersion } = exp;\n\n  // Only allow projects to be published with UNVERSIONED if a correct token is set in env\n  if (sdkVersion === 'UNVERSIONED' && !maySkipManifestValidation()) {\n    throw new XDLError('INVALID_OPTIONS', 'Cannot publish with sdkVersion UNVERSIONED.');\n  }\n  exp.locales = await ExponentTools.getResolvedLocalesAsync(projectRoot, exp);\n  return {\n    exp: {\n      ...exp,\n      sdkVersion: sdkVersion!,\n    },\n    pkg,\n    hooks,\n  };\n}\n\nasync function buildPublishBundlesAsync(\n  projectRoot: string,\n  publishOptions: PublishOptions = {},\n  bundleOptions: { dev?: boolean; useDevServer: boolean }\n) {\n  if (!bundleOptions.useDevServer) {\n    try {\n      await startReactNativeServerAsync({\n        projectRoot,\n        options: {\n          nonPersistent: true,\n          maxWorkers: publishOptions.maxWorkers,\n          target: publishOptions.target,\n          reset: publishOptions.resetCache,\n        },\n        verbose: !publishOptions.quiet,\n      });\n      return await fetchPublishBundlesAsync(projectRoot);\n    } finally {\n      await stopReactNativeServerAsync(projectRoot);\n    }\n  }\n\n  const platforms: Platform[] = ['android', 'ios'];\n  const [android, ios] = await bundleAsync(\n    projectRoot,\n    {\n      target: publishOptions.target,\n      resetCache: publishOptions.resetCache,\n      logger: ProjectUtils.getLogger(projectRoot),\n      quiet: publishOptions.quiet,\n    },\n    platforms.map((platform: Platform) => ({\n      platform,\n      entryPoint: Exp.determineEntryPoint(projectRoot, platform),\n      dev: bundleOptions.dev,\n    }))\n  );\n\n  return {\n    android,\n    ios,\n  };\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function fetchPublishBundlesAsync(projectRoot: string, opts?: PackagerOptions) {\n  const entryPoint = Exp.determineEntryPoint(projectRoot);\n  const publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint,\n    undefined,\n    opts\n  );\n  const sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n  const assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building iOS bundle');\n  const iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  const androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building source maps');\n  const iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n  const androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building asset maps');\n  const iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: 'INVALID_ASSETS',\n  });\n  const androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  return {\n    android: { code: androidBundle, map: androidSourceMap, assets: JSON.parse(androidAssetsJson) },\n    ios: { code: iosBundle, map: iosSourceMap, assets: JSON.parse(iosAssetsJson) },\n  };\n}\n\nasync function _getForPlatformAsync(\n  projectRoot: string,\n  url: string,\n  platform: Platform,\n  { errorCode, minLength }: { errorCode: ErrorCode; minLength?: number }\n): Promise<string> {\n  const fullUrl = `${url}&platform=${platform}`;\n  let response;\n\n  try {\n    response = await axios.request({\n      url: fullUrl,\n      responseType: 'text',\n      // Workaround for https://github.com/axios/axios/issues/907.\n      // Without transformResponse, axios will parse the body as JSON regardless of the responseType/\n      transformResponse: [data => data],\n      proxy: false,\n      validateStatus: status => status === 200,\n      headers: {\n        'Exponent-Platform': platform,\n      },\n    });\n  } catch (error) {\n    if (error.response) {\n      if (error.response.data) {\n        let body;\n        try {\n          body = JSON.parse(error.response.data);\n        } catch (e) {\n          ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n        }\n\n        if (body) {\n          if (body.message) {\n            ProjectUtils.logError(projectRoot, 'expo', body.message);\n          } else {\n            ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n          }\n        }\n      }\n      throw new XDLError(\n        errorCode,\n        `Packager URL ${fullUrl} returned unexpected code ${error.response.status}. ` +\n          'Please open your project in the Expo app and see if there are any errors. ' +\n          'Also scroll up and make sure there were no errors or warnings when opening your project.'\n      );\n    } else {\n      throw error;\n    }\n  }\n\n  if (!response.data || (minLength && response.data.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.data}`);\n  }\n\n  return response.data;\n}\n\nasync function _handleKernelPublishedAsync({\n  projectRoot,\n  user,\n  exp,\n  url,\n}: {\n  projectRoot: string;\n  user: User;\n  exp: ExpoAppManifest;\n  url: string;\n}) {\n  let kernelBundleUrl = `${Config.api.scheme}://${Config.api.host}`;\n  if (Config.api.port) {\n    kernelBundleUrl = `${kernelBundleUrl}:${Config.api.port}`;\n  }\n  kernelBundleUrl = `${kernelBundleUrl}/@${user.username}/${exp.slug}/bundle`;\n\n  if (exp.kernel?.androidManifestPath) {\n    const manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'android',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.androidManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n\n  if (exp.kernel?.iosManifestPath) {\n    const manifest = await ExponentTools.getManifestAsync(url, {\n      'Exponent-SDK-Version': exp.sdkVersion,\n      'Exponent-Platform': 'ios',\n      Accept: 'application/expo+json,application/json',\n    });\n    manifest.bundleUrl = kernelBundleUrl;\n    manifest.sdkVersion = 'UNVERSIONED';\n    await fs.writeFile(\n      path.resolve(projectRoot, exp.kernel.iosManifestPath),\n      JSON.stringify(manifest)\n    );\n  }\n}\n\ntype GetExpConfigOptions = {\n  current?: boolean;\n  mode?: string;\n  platform?: 'android' | 'ios' | 'all';\n  expIds?: string[];\n  type?: string;\n  releaseChannel?: string;\n  bundleIdentifier?: string;\n  publicUrl?: string;\n  sdkVersion?: string;\n};\n\nasync function getConfigAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'platform'> = {}\n) {\n  if (!options.publicUrl) {\n    // get the manifest from the project directory\n    const { exp, pkg } = getConfig(projectRoot);\n    const configName = configFilename(projectRoot);\n    return {\n      exp,\n      pkg,\n      configName: configFilename(projectRoot),\n      configPrefix: configName === 'app.json' ? 'expo.' : '',\n    };\n  } else {\n    // get the externally hosted manifest\n    return {\n      exp: await ThirdParty.getManifest(options.publicUrl, options),\n      configName: options.publicUrl,\n      configPrefix: '',\n      pkg: {},\n    };\n  }\n}\n\ntype JobState = 'pending' | 'started' | 'in-progress' | 'finished' | 'errored' | 'sent-to-queue';\n\nexport type TurtleMode = 'normal' | 'high' | 'high_only';\n\n// https://github.com/expo/universe/blob/283efaba3acfdefdc7db12f649516b6d6a94bec4/server/www/src/data/entities/builds/BuildJobEntity.ts#L25-L56\nexport interface BuildJobFields {\n  id: string;\n  experienceName: string;\n  status: JobState;\n  platform: 'ios' | 'android';\n  userId: string | null;\n  experienceId: string;\n  artifactId: string | null;\n  nonce: string | null;\n  artifacts: {\n    url?: string;\n    manifestPlistUrl?: string;\n  } | null;\n  config: {\n    buildType?: string;\n    releaseChannel?: string;\n    bundleIdentifier?: string;\n  };\n  logs: object | null;\n  extraData: {\n    request_id?: string;\n    turtleMode?: TurtleMode;\n  } | null;\n  created: Date;\n  updated: Date;\n  expirationDate: Date;\n  sdkVersion: string | null;\n  turtleVersion: string | null;\n  buildDuration: number | null;\n  priority: string;\n  accountId: string | null;\n}\n\nexport type BuildStatusResult = {\n  jobs?: BuildJobFields[];\n  err?: null;\n  userHasBuiltAppBefore: boolean;\n  userHasBuiltExperienceBefore: boolean;\n  canPurchasePriorityBuilds?: boolean;\n  numberOfRemainingPriorityBuilds?: number;\n  hasUnlimitedPriorityBuilds?: boolean;\n};\n\nexport type BuildCreatedResult = {\n  id: string;\n  ids: string[];\n  priority: 'normal' | 'high';\n  canPurchasePriorityBuilds: boolean;\n  numberOfRemainingPriorityBuilds: number;\n  hasUnlimitedPriorityBuilds: boolean;\n};\n\nfunction _validateManifest(options: any, exp: any, configName: string, configPrefix: string) {\n  if (options.platform === 'ios' || options.platform === 'all') {\n    if (!exp.ios || !exp.ios.bundleIdentifier) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a bundle identifier in order to build this experience for iOS. ` +\n          `Please specify one in ${configName} at \"${configPrefix}ios.bundleIdentifier\"`\n      );\n    }\n  }\n\n  if (options.platform === 'android' || options.platform === 'all') {\n    if (!exp.android || !exp.android.package) {\n      throw new XDLError(\n        'INVALID_MANIFEST',\n        `Must specify a java package in order to build this experience for Android. ` +\n          `Please specify one in ${configName} at \"${configPrefix}android.package\"`\n      );\n    }\n  }\n}\nfunction _validateOptions(options: any) {\n  const schema = joi.object().keys({\n    current: joi.boolean(),\n    mode: joi.string(),\n    platform: joi.any().valid('ios', 'android', 'all'),\n    expIds: joi.array(),\n    type: joi.any().valid('archive', 'simulator', 'client', 'app-bundle', 'apk'),\n    releaseChannel: joi.string().regex(/[a-z\\d][a-z\\d._-]*/),\n    bundleIdentifier: joi.string().regex(/^[a-zA-Z][a-zA-Z0-9\\-.]+$/),\n    publicUrl: joi.string(),\n    sdkVersion: joi.string().strict(),\n  });\n\n  const { error } = schema.validate(options);\n  if (error) {\n    throw new XDLError('INVALID_OPTIONS', error.toString());\n  }\n}\n\nasync function _getExpAsync(\n  projectRoot: string,\n  options: Pick<GetExpConfigOptions, 'publicUrl' | 'mode' | 'platform'>\n) {\n  const { exp, pkg, configName, configPrefix } = await getConfigAsync(projectRoot, options);\n\n  if (!exp || !pkg) {\n    throw new XDLError(\n      'NO_PACKAGE_JSON',\n      `Couldn't read ${configName} file in project at ${projectRoot}`\n    );\n  }\n\n  // Support version and name being specified in package.json for legacy\n  // support pre: exp.json\n  if (!exp.version && 'version' in pkg && pkg.version) {\n    exp.version = pkg.version;\n  }\n  if (!exp.name && 'name' in pkg && typeof pkg.name === 'string') {\n    exp.name = pkg.name;\n  }\n  if (!exp.slug && typeof exp.name === 'string') {\n    exp.slug = slug(exp.name.toLowerCase());\n  }\n  return { exp, configName, configPrefix };\n}\n\nexport async function getBuildStatusAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildStatusResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  assertValidProjectRoot(projectRoot);\n  _validateOptions(options);\n  const { exp } = await _getExpAsync(projectRoot, options);\n\n  const api = ApiV2.clientForUser(user);\n  return await api.postAsync('build/status', { manifest: exp, options });\n}\n\nexport async function startBuildAsync(\n  projectRoot: string,\n  options: GetExpConfigOptions = {}\n): Promise<BuildCreatedResult> {\n  const user = await UserManager.ensureLoggedInAsync();\n\n  assertValidProjectRoot(projectRoot);\n  _validateOptions(options);\n  const { exp, configName, configPrefix } = await _getExpAsync(projectRoot, options);\n  _validateManifest(options, exp, configName, configPrefix);\n\n  Analytics.logEvent('Build Shell App', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    platform: options.platform,\n  });\n\n  const api = ApiV2.clientForUser(user);\n  return await api.putAsync('build/start', { manifest: exp, options });\n}\n\nasync function _waitForRunningAsync(\n  projectRoot: string,\n  url: string,\n  retries: number = 300\n): Promise<true> {\n  try {\n    const response = await axios.request({\n      url,\n      responseType: 'text',\n      proxy: false,\n    });\n    if (/packager-status:running/.test(response.data)) {\n      return true;\n    } else if (retries === 0) {\n      ProjectUtils.logError(\n        projectRoot,\n        'expo',\n        `Could not get status from Metro bundler. Server response: ${response.data}`\n      );\n    }\n  } catch (e) {\n    if (retries === 0) {\n      ProjectUtils.logError(\n        projectRoot,\n        'expo',\n        `Could not get status from Metro bundler. ${e.message}`\n      );\n    }\n  }\n\n  if (retries <= 0) {\n    throw new Error('Connecting to Metro bundler failed.');\n  } else {\n    await delayAsync(100);\n    return _waitForRunningAsync(projectRoot, url, retries - 1);\n  }\n}\n\n// The --verbose flag is intended for react-native-cli/metro, not expo-cli\nconst METRO_VERBOSE_WARNING = 'Run CLI with --verbose flag for more details.';\n\n// Remove these constants and related code when SDK35 isn't supported anymore\n// Context: https://github.com/expo/expo-cli/issues/1074\nconst NODE_12_WINDOWS_METRO_ERROR = `Invalid regular expression: /(.*\\\\__fixtures__\\\\.*|node_modules[\\\\]react[\\\\]dist[\\\\].*|website\\\\node_modules\\\\.*|heapCapture\\\\bundle.js|.*\\\\__tests__\\\\.*)$/: Unterminated character class`;\nconst NODE_12_WINDOWS_METRO_SUGGESTION = `\\nUnable to start the project due to a documented incompatibility between Node 12 LTS and Expo SDK 35 on Windows.\nPlease refer to this GitHub comment for a solution:\nhttps://github.com/expo/expo-cli/issues/1074#issuecomment-559220752\\n`;\n\nfunction _logPackagerOutput(projectRoot: string, level: string, data: object) {\n  let output = data.toString();\n  if (!output) {\n    return;\n  }\n  // Temporarily hide warnings about duplicate providesModule declarations\n  // under react-native\n  if (_isIgnorableDuplicateModuleWarning(projectRoot, level, output)) {\n    ProjectUtils.logDebug(\n      projectRoot,\n      'expo',\n      `Suppressing @providesModule warning: ${output}`,\n      'project-suppress-providesmodule-warning'\n    );\n    return;\n  }\n  if (_isIgnorableMetroConsoleOutput(output) || _isIgnorableRnpmWarning(output)) {\n    ProjectUtils.logDebug(projectRoot, 'expo', output);\n    return;\n  }\n\n  if (output.includes(NODE_12_WINDOWS_METRO_ERROR)) {\n    ProjectUtils.logError(projectRoot, 'expo', NODE_12_WINDOWS_METRO_SUGGESTION);\n    return;\n  }\n\n  if (output.includes(METRO_VERBOSE_WARNING)) {\n    output = output.replace(METRO_VERBOSE_WARNING, '');\n  }\n\n  if (/^Scanning folders for symlinks in /.test(output)) {\n    ProjectUtils.logDebug(projectRoot, 'metro', output);\n    return;\n  }\n  if (level === 'info') {\n    ProjectUtils.logInfo(projectRoot, 'metro', output);\n  } else {\n    ProjectUtils.logError(projectRoot, 'metro', output);\n  }\n}\n\nfunction _isIgnorableMetroConsoleOutput(output: string) {\n  // As of react-native 0.61.x, Metro prints console logs from the device to console, without\n  // passing them through the custom log reporter.\n  //\n  // Managed apps have a separate remote logging implementation included in the Expo SDK,\n  // (see: _handleDeviceLogs), so we can just ignore these device logs from Metro.\n  // if (/^ () /)\n  //\n  // These logs originate from:\n  // https://github.com/facebook/metro/blob/e8181fb9db7db31adf7d1ed9ab840f54449ef238/packages/metro/src/lib/logToConsole.js#L50\n  return /^\\s+(INFO|WARN|LOG|GROUP|DEBUG) /.test(output);\n}\n\nfunction _isIgnorableRnpmWarning(output: string) {\n  return output.startsWith(\n    'warn The following packages use deprecated \"rnpm\" config that will stop working from next release'\n  );\n}\n\nfunction _isIgnorableDuplicateModuleWarning(\n  projectRoot: string,\n  level: string,\n  output: string\n): boolean {\n  if (\n    level !== 'error' ||\n    !output.startsWith('jest-haste-map: @providesModule naming collision:')\n  ) {\n    return false;\n  }\n\n  const reactNativeNodeModulesPath = path.join(\n    projectRoot,\n    'node_modules',\n    'react-native',\n    'node_modules'\n  );\n  const reactNativeNodeModulesPattern = escapeRegExp(reactNativeNodeModulesPath);\n  const reactNativeNodeModulesCollisionRegex = new RegExp(\n    `Paths: ${reactNativeNodeModulesPattern}.+ collides with ${reactNativeNodeModulesPattern}.+`\n  );\n  return reactNativeNodeModulesCollisionRegex.test(output);\n}\n\nfunction _isIgnorableBugReportingExtraData(body: any[]) {\n  return body.length === 2 && body[0] === 'BugReporting extraData:';\n}\n\nfunction _isAppRegistryStartupMessage(body: any[]) {\n  return (\n    body.length === 1 &&\n    (/^Running application \"main\" with appParams:/.test(body[0]) ||\n      /^Running \"main\" with \\{/.test(body[0]))\n  );\n}\n\ntype ConsoleLogLevel = 'info' | 'warn' | 'error' | 'debug';\n\nfunction _handleDeviceLogs(projectRoot: string, deviceId: string, deviceName: string, logs: any) {\n  for (let i = 0; i < logs.length; i++) {\n    const log = logs[i];\n    let body = typeof log.body === 'string' ? [log.body] : log.body;\n    let { level } = log;\n\n    if (_isIgnorableBugReportingExtraData(body)) {\n      level = 'debug';\n    }\n    if (_isAppRegistryStartupMessage(body)) {\n      body = [`Running application on ${deviceName}.`];\n    }\n\n    const args = body.map((obj: any) => {\n      if (typeof obj === 'undefined') {\n        return 'undefined';\n      }\n      if (obj === 'null') {\n        return 'null';\n      }\n      if (typeof obj === 'string' || typeof obj === 'number' || typeof obj === 'boolean') {\n        return obj;\n      }\n      try {\n        return JSON.stringify(obj);\n      } catch (e) {\n        return obj.toString();\n      }\n    });\n    const logLevel =\n      level === 'info' || level === 'warn' || level === 'error' || level === 'debug'\n        ? (level as ConsoleLogLevel)\n        : 'info';\n    ProjectUtils.getLogger(projectRoot)[logLevel](\n      {\n        tag: 'device',\n        deviceId,\n        deviceName,\n        groupDepth: log.groupDepth,\n        shouldHide: log.shouldHide,\n        includesStack: log.includesStack,\n      },\n      ...args\n    );\n  }\n}\nexport async function startReactNativeServerAsync({\n  projectRoot,\n  options = {},\n  exp = getConfig(projectRoot).exp,\n  verbose = true,\n}: {\n  projectRoot: string;\n  options: StartOptions;\n  exp?: ExpoConfig;\n  verbose?: boolean;\n}): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  await stopReactNativeServerAsync(projectRoot);\n  await Watchman.addToPathAsync(); // Attempt to fix watchman if it's hanging\n  await Watchman.unblockAndGetVersionAsync(projectRoot);\n\n  let packagerPort = await _getFreePortAsync(19001); // Create packager options\n\n  const customLogReporterPath: string = require.resolve(path.join(__dirname, '../build/reporter'));\n\n  // TODO: Bacon: Support .mjs (short-lived JS modules extension that some packages use)\n  const sourceExtsConfig = { isTS: true, isReact: true, isModern: false };\n  const sourceExts =\n    options.target === 'bare'\n      ? getBareExtensions([], sourceExtsConfig)\n      : getManagedExtensions([], sourceExtsConfig);\n\n  let packagerOpts: { [key: string]: any } = {\n    port: packagerPort,\n    customLogReporterPath,\n    sourceExts,\n  };\n\n  if (options.nonPersistent && Versions.lteSdkVersion(exp, '32.0.0')) {\n    packagerOpts.nonPersistent = true;\n  }\n\n  if (Versions.gteSdkVersion(exp, '33.0.0')) {\n    // starting with SDK 37, we bundle this plugin with the expo-asset package instead of expo,\n    // so check there first and fall back to expo if we can't find it in expo-asset\n    try {\n      packagerOpts.assetPlugins = resolveModule(\n        'expo-asset/tools/hashAssetFiles',\n        projectRoot,\n        exp\n      );\n    } catch (e) {\n      try {\n        packagerOpts.assetPlugins = resolveModule('expo/tools/hashAssetFiles', projectRoot, exp);\n      } catch (e) {\n        throw new Error(\n          'Unable to find the expo-asset package in the current project. Install it and try again.'\n        );\n      }\n    }\n  }\n\n  if (options.maxWorkers) {\n    packagerOpts['max-workers'] = options.maxWorkers;\n  }\n\n  if (!Versions.gteSdkVersion(exp, '16.0.0')) {\n    delete packagerOpts.customLogReporterPath;\n  }\n  const userPackagerOpts = exp.packagerOpts;\n\n  if (userPackagerOpts) {\n    // The RN CLI expects rn-cli.config.js's path to be absolute. We use the\n    // project root to resolve relative paths since that was the original\n    // behavior of the RN CLI.\n    if (userPackagerOpts.config) {\n      userPackagerOpts.config = path.resolve(projectRoot, userPackagerOpts.config);\n    }\n\n    // Provide a fallback if the value isn't given\n    const userSourceExts = userPackagerOpts.sourceExts ?? [];\n\n    packagerOpts = {\n      ...packagerOpts,\n      ...userPackagerOpts,\n      // In order to prevent people from forgetting to include the .expo extension or other things\n      // NOTE(brentvatne): we should probably do away with packagerOpts soon in favor of @expo/metro-config!\n      sourceExts: [...new Set([...packagerOpts.sourceExts, ...userSourceExts])],\n    };\n\n    if (userPackagerOpts.port !== undefined && userPackagerOpts.port !== null) {\n      packagerPort = userPackagerOpts.port;\n    }\n  }\n  const cliOpts = ['start'];\n  for (const [key, val] of Object.entries(packagerOpts)) {\n    // If the packager opt value is boolean, don't set\n    // --[opt] [value], just set '--opt'\n    if (val && typeof val === 'boolean') {\n      cliOpts.push(`--${key}`);\n    } else if (val) {\n      cliOpts.push(`--${key}`, val);\n    }\n  }\n\n  if (process.env.EXPO_DEBUG) {\n    cliOpts.push('--verbose');\n  }\n\n  if (options.reset) {\n    cliOpts.push('--reset-cache');\n  }\n\n  // Get custom CLI path from project package.json, but fall back to node_module path\n  const defaultCliPath = resolveModule('react-native/local-cli/cli.js', projectRoot, exp);\n  const cliPath = exp.rnCliPath || defaultCliPath;\n\n  let nodePath;\n  // When using a custom path for the RN CLI, we want it to use the project\n  // root to look up config files and Node modules\n  if (exp.rnCliPath) {\n    nodePath = _nodePathForProjectRoot(projectRoot);\n  } else {\n    nodePath = null;\n  }\n\n  // Run the copy of Node that's embedded in Electron by setting the\n  // ELECTRON_RUN_AS_NODE environment variable\n  // Note: the CLI script sets up graceful-fs and sets ulimit to 4096 in the\n  // child process\n  const nodePathEnv = nodePath ? { NODE_PATH: nodePath } : {};\n  const packagerProcess = child_process.fork(cliPath, cliOpts, {\n    cwd: projectRoot,\n    env: {\n      ...process.env,\n      NODE_OPTIONS: process.env.METRO_NODE_OPTIONS,\n      REACT_NATIVE_APP_ROOT: projectRoot,\n      ELECTRON_RUN_AS_NODE: '1',\n      ...nodePathEnv,\n    },\n    silent: true,\n  });\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort,\n    packagerPid: packagerProcess.pid,\n  }); // TODO: do we need this? don't know if it's ever called\n  process.on('exit', () => {\n    treekill(packagerProcess.pid);\n  });\n  if (!packagerProcess.stdout) {\n    throw new Error('Expected spawned process to have a stdout stream, but none was found.');\n  }\n  if (!packagerProcess.stderr) {\n    throw new Error('Expected spawned process to have a stderr stream, but none was found.');\n  }\n  packagerProcess.stdout.setEncoding('utf8');\n  packagerProcess.stderr.setEncoding('utf8');\n  packagerProcess.stdout.pipe(split()).on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'info', data);\n    }\n  });\n  packagerProcess.stderr.on('data', data => {\n    if (verbose) {\n      _logPackagerOutput(projectRoot, 'error', data);\n    }\n  });\n  const exitPromise = new Promise<void>((resolve, reject) => {\n    packagerProcess.once('exit', async code => {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Metro Bundler process exited with code ${code}`);\n      if (code) {\n        reject(new Error(`Metro Bundler process exited with code ${code}`));\n      } else {\n        resolve();\n      }\n      try {\n        await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n          packagerPort: null,\n          packagerPid: null,\n        });\n      } catch (e) {}\n    });\n  });\n  const packagerUrl = await UrlUtils.constructBundleUrlAsync(projectRoot, {\n    urlType: 'http',\n    hostType: 'localhost',\n  });\n  await Promise.race([_waitForRunningAsync(projectRoot, `${packagerUrl}/status`), exitPromise]);\n}\n\n// Simulate the node_modules resolution\n// If you project dir is /Jesse/Expo/Universe/BubbleBounce, returns\n// \"/Jesse/node_modules:/Jesse/Expo/node_modules:/Jesse/Expo/Universe/node_modules:/Jesse/Expo/Universe/BubbleBounce/node_modules\"\nfunction _nodePathForProjectRoot(projectRoot: string): string {\n  const paths = [];\n  let directory = path.resolve(projectRoot);\n  while (true) {\n    paths.push(path.join(directory, 'node_modules'));\n    const parentDirectory = path.dirname(directory);\n    if (directory === parentDirectory) {\n      break;\n    }\n    directory = parentDirectory;\n  }\n  return paths.join(path.delimiter);\n}\nexport async function stopReactNativeServerAsync(projectRoot: string): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (!packagerInfo.packagerPort || !packagerInfo.packagerPid) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `No packager found for project at ${projectRoot}.`);\n    return;\n  }\n  ProjectUtils.logDebug(\n    projectRoot,\n    'expo',\n    `Killing packager process tree: ${packagerInfo.packagerPid}`\n  );\n  try {\n    await treekillAsync(packagerInfo.packagerPid, 'SIGKILL');\n  } catch (e) {\n    ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping packager process: ${e.toString()}`);\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    packagerPort: null,\n    packagerPid: null,\n  });\n}\n\nexport async function startExpoServerAsync(\n  projectRoot: string,\n  options: StartOptions\n): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  await stopExpoServerAsync(projectRoot);\n  const app = express();\n  app.use(\n    express.json({\n      limit: '10mb',\n    })\n  );\n  app.use(\n    express.urlencoded({\n      limit: '10mb',\n      extended: true,\n    })\n  );\n  if (\n    (ConnectionStatus.isOffline()\n      ? await Doctor.validateWithoutNetworkAsync(projectRoot)\n      : await Doctor.validateWithNetworkAsync(projectRoot)) === Doctor.FATAL\n  ) {\n    throw new Error(`Couldn't start project. Please fix the errors and restart the project.`);\n  }\n  // Serve the manifest.\n  const manifestHandler = getManifestHandler(projectRoot);\n  app.get('/', manifestHandler);\n  app.get('/manifest', manifestHandler);\n  app.get('/index.exp', manifestHandler);\n  app.post('/logs', async (req, res) => {\n    try {\n      const deviceId = req.get('Device-Id');\n      const deviceName = req.get('Device-Name');\n      if (deviceId && deviceName && req.body) {\n        _handleDeviceLogs(projectRoot, deviceId, deviceName, req.body);\n      }\n    } catch (e) {\n      ProjectUtils.logError(projectRoot, 'expo', `Error getting device logs: ${e} ${e.stack}`);\n    }\n    res.send('Success');\n  });\n  app.post('/shutdown', async (req, res) => {\n    server.close();\n    res.send('Success');\n  });\n  const expRc = await readExpRcAsync(projectRoot);\n  const expoServerPort = expRc.manifestPort ? expRc.manifestPort : await _getFreePortAsync(19000);\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort,\n  });\n  let server = app.listen(expoServerPort, () => {\n    const info = server.address() as AddressInfo;\n    const host = info.address;\n    const port = info.port;\n    ProjectUtils.logDebug(projectRoot, 'expo', `Local server listening at http://${host}:${port}`);\n  });\n}\n\nasync function stopExpoServerAsync(projectRoot: string): Promise<void> {\n  assertValidProjectRoot(projectRoot);\n  const packagerInfo = await ProjectSettings.readPackagerInfoAsync(projectRoot);\n  if (packagerInfo && packagerInfo.expoServerPort) {\n    try {\n      await axios.request({\n        method: 'post',\n        url: `http://127.0.0.1:${packagerInfo.expoServerPort}/shutdown`,\n      });\n    } catch (e) {}\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: null,\n  });\n}\n\nasync function startDevServerAsync(projectRoot: string, startOptions: StartOptions) {\n  assertValidProjectRoot(projectRoot);\n\n  const port = await _getFreePortAsync(19000); // Create packager options\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, {\n    expoServerPort: port,\n    packagerPort: port,\n  });\n\n  const options: MetroDevServerOptions = {\n    port,\n    logger: ProjectUtils.getLogger(projectRoot),\n  };\n  if (startOptions.reset) {\n    options.resetCache = true;\n  }\n  if (startOptions.maxWorkers != null) {\n    options.maxWorkers = startOptions.maxWorkers;\n  }\n  if (startOptions.target) {\n    // EXPO_TARGET is used by @expo/metro-config to determine the target when getDefaultConfig is\n    // called from metro.config.js.\n    process.env.EXPO_TARGET = startOptions.target;\n  }\n\n  const { middleware } = await runMetroDevServerAsync(projectRoot, options);\n  middleware.use(getManifestHandler(projectRoot));\n}\n\nexport async function setOptionsAsync(\n  projectRoot: string,\n  options: {\n    packagerPort?: number;\n  }\n): Promise<void> {\n  assertValidProjectRoot(projectRoot); // Check to make sure all options are valid\n  if (options.packagerPort != null && !Number.isInteger(options.packagerPort)) {\n    throw new XDLError('INVALID_OPTIONS', 'packagerPort must be an integer');\n  }\n  await ProjectSettings.setPackagerInfoAsync(projectRoot, options);\n}\n\nexport async function startAsync(\n  projectRoot: string,\n  { exp = getConfig(projectRoot).exp, ...options }: StartOptions & { exp?: ExpoConfig } = {},\n  verbose: boolean = true\n): Promise<ExpoConfig> {\n  assertValidProjectRoot(projectRoot);\n  Analytics.logEvent('Start Project', {\n    projectRoot,\n    developerTool: Config.developerTool,\n    sdkVersion: exp.sdkVersion ?? null,\n  });\n\n  if (options.webOnly) {\n    await Webpack.restartAsync(projectRoot, options);\n    DevSession.startSession(projectRoot, exp, 'web');\n    return exp;\n  } else if (shouldUseDevServer(exp) || options.devClient) {\n    await startDevServerAsync(projectRoot, options);\n    DevSession.startSession(projectRoot, exp, 'native');\n  } else {\n    await startExpoServerAsync(projectRoot, options);\n    await startReactNativeServerAsync({ projectRoot, exp, options, verbose });\n    DevSession.startSession(projectRoot, exp, 'native');\n  }\n\n  const { hostType } = await ProjectSettings.readAsync(projectRoot);\n\n  if (!Config.offline && hostType === 'tunnel') {\n    try {\n      await startTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error starting tunnel ${e.message}`);\n    }\n  }\n  return exp;\n}\n\nasync function _stopInternalAsync(projectRoot: string): Promise<void> {\n  DevSession.stopSession();\n  await Webpack.stopAsync(projectRoot);\n  ProjectUtils.logInfo(projectRoot, 'expo', '\\u203A Closing Expo server');\n  await stopExpoServerAsync(projectRoot);\n  ProjectUtils.logInfo(projectRoot, 'expo', '\\u203A Stopping Metro bundler');\n  await stopReactNativeServerAsync(projectRoot);\n  if (!Config.offline) {\n    try {\n      await stopTunnelsAsync(projectRoot);\n    } catch (e) {\n      ProjectUtils.logDebug(projectRoot, 'expo', `Error stopping ngrok ${e.message}`);\n    }\n  }\n\n  await Android.maybeStopAdbDaemonAsync();\n}\n\nexport async function stopWebOnlyAsync(projectDir: string): Promise<void> {\n  await Webpack.stopAsync(projectDir);\n  await DevSession.stopSession();\n}\n\nexport async function stopAsync(projectDir: string): Promise<void> {\n  const result = await Promise.race([\n    _stopInternalAsync(projectDir),\n    new Promise(resolve => setTimeout(resolve, 2000, 'stopFailed')),\n  ]);\n  if (result === 'stopFailed') {\n    // find RN packager and ngrok pids, attempt to kill them manually\n    const { packagerPid, ngrokPid } = await ProjectSettings.readPackagerInfoAsync(projectDir);\n    if (packagerPid) {\n      try {\n        process.kill(packagerPid);\n      } catch (e) {}\n    }\n    if (ngrokPid) {\n      try {\n        process.kill(ngrokPid);\n      } catch (e) {}\n    }\n    await ProjectSettings.setPackagerInfoAsync(projectDir, {\n      expoServerPort: null,\n      packagerPort: null,\n      packagerPid: null,\n      expoServerNgrokUrl: null,\n      packagerNgrokUrl: null,\n      ngrokPid: null,\n      webpackServerPort: null,\n    });\n  }\n}\n\nexport { startTunnelsAsync, stopTunnelsAsync };\n"],"file":"../Project.js","sourceRoot":"/@expo/xdl@59.0.19/src"}