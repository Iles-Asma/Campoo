{"version":3,"sources":["../../src/appleApi/distributionCert.ts"],"names":["AppleTooManyCertsError","CommandError","getCertificateBySerialNumberAsync","context","serialNumber","cert","Certificate","getAsync","find","item","attributes","getDistributionCertificateAync","certificates","query","filter","certificateType","CertificateType","IOS_DISTRIBUTION","certificate","transformCertificate","id","name","status","created","Date","requestedDate","getTime","expires","expirationDate","ownerName","ownerId","listDistributionCertificatesAsync","authCtx","spinner","start","certs","DISTRIBUTION","MAC_APP_DISTRIBUTION","map","succeed","error","fail","createDistributionCertificateAsync","results","certId","certP12","certificateP12","certPassword","password","certPrivateSigningKey","privateSigningKey","distCertSerialNumber","teamId","team","teamName","test","message","ErrorCodes","APPLE_DIST_CERTS_TOO_MANY_GENERATED_ERROR","revokeDistributionCertificateAsync","ids","length","Promise","all","deleteAsync","isDistCert","obj","chalk","underline","DistCertManager","constructor","ctx","list","create","revoke","format","expiresDate","_formatTimestamp","createdDate","timestamp"],"mappings":"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","sourcesContent":["import {\n  Certificate,\n  CertificateType,\n  createCertificateAndP12Async,\n  RequestContext,\n} from '@expo/apple-utils';\nimport chalk from 'chalk';\nimport dateformat from 'dateformat';\nimport ora from 'ora';\n\nimport CommandError, { ErrorCodes } from '../CommandError';\nimport { AppleCtx, getRequestContext } from './authenticate';\n\nexport type DistCertInfo = {\n  id: string;\n  name: string;\n  status: string;\n  created: number;\n  expires: number;\n  ownerName: string;\n  ownerId: string;\n  serialNumber: string;\n};\n\nexport type DistCert = {\n  certId?: string;\n  certP12: string;\n  certPassword: string;\n  certPrivateSigningKey?: string;\n  distCertSerialNumber?: string;\n  teamId: string;\n  teamName?: string;\n};\n\nexport class AppleTooManyCertsError extends CommandError {}\n\nexport async function getCertificateBySerialNumberAsync(\n  context: RequestContext,\n  serialNumber: string\n): Promise<Certificate> {\n  const cert = (await Certificate.getAsync(context)).find(\n    item => item.attributes.serialNumber === serialNumber\n  );\n  if (!cert) {\n    throw new CommandError(`No certificate exists with serial number \"${serialNumber}\"`);\n  }\n  return cert;\n}\n\nexport async function getDistributionCertificateAync(\n  context: RequestContext,\n  serialNumber: string\n): Promise<Certificate | null> {\n  // At most, this returns 2 values.\n  const certificates = await Certificate.getAsync(context, {\n    query: {\n      filter: {\n        certificateType: CertificateType.IOS_DISTRIBUTION,\n      },\n    },\n  });\n  return (\n    certificates.find(certificate => certificate.attributes.serialNumber === serialNumber) ?? null\n  );\n}\n\nexport function transformCertificate(cert: Certificate): DistCertInfo {\n  return {\n    id: cert.id,\n    name: cert.attributes.name,\n    status: cert.attributes.status,\n    created: new Date(cert.attributes.requestedDate).getTime() / 1000,\n    expires: new Date(cert.attributes.expirationDate).getTime() / 1000,\n    ownerName: cert.attributes.ownerName,\n    ownerId: cert.attributes.ownerId,\n    serialNumber: cert.attributes.serialNumber,\n  };\n}\n\nexport async function listDistributionCertificatesAsync(\n  authCtx: AppleCtx\n): Promise<DistCertInfo[]> {\n  const spinner = ora(`Fetching Apple distribution certificates`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    const certs = (\n      await Certificate.getAsync(context, {\n        query: {\n          filter: {\n            certificateType: [\n              CertificateType.DISTRIBUTION,\n              CertificateType.IOS_DISTRIBUTION,\n              CertificateType.MAC_APP_DISTRIBUTION,\n            ],\n          },\n        },\n      })\n    ).map(transformCertificate);\n    spinner.succeed(`Fetched Apple distribution certificates`);\n    return certs;\n  } catch (error) {\n    spinner.fail(`Failed to fetch Apple distribution certificates`);\n    throw error;\n  }\n}\n\n/**\n * Run from `eas credentials` -> iOS -> Add new Distribution Certificate\n */\nexport async function createDistributionCertificateAsync(authCtx: AppleCtx): Promise<DistCert> {\n  const spinner = ora(`Creating Apple distribution certificate`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    const results = await createCertificateAndP12Async(context, {\n      certificateType: CertificateType.IOS_DISTRIBUTION,\n    });\n    spinner.succeed(`Created Apple distribution certificate`);\n    return {\n      certId: results.certificate.id,\n      certP12: results.certificateP12,\n      certPassword: results.password,\n      certPrivateSigningKey: results.privateSigningKey,\n      distCertSerialNumber: results.certificate.attributes.serialNumber,\n      teamId: authCtx.team.id,\n      teamName: authCtx.team.name,\n    };\n  } catch (error) {\n    spinner.fail('Failed to create Apple distribution certificate');\n    // TODO: Move check into apple-utils\n    if (\n      /You already have a current .* certificate or a pending certificate request/.test(\n        error.message\n      )\n    ) {\n      throw new AppleTooManyCertsError(\n        ErrorCodes.APPLE_DIST_CERTS_TOO_MANY_GENERATED_ERROR,\n        APPLE_DIST_CERTS_TOO_MANY_GENERATED_ERROR\n      );\n    }\n    throw error;\n  }\n}\n\nexport async function revokeDistributionCertificateAsync(\n  authCtx: AppleCtx,\n  ids: string[]\n): Promise<void> {\n  const name = `Apple distribution certificate${ids?.length === 1 ? '' : 's'}`;\n  const spinner = ora(`Revoking ${name}`).start();\n  try {\n    const context = getRequestContext(authCtx);\n    await Promise.all(ids.map(id => Certificate.deleteAsync(context, { id })));\n\n    spinner.succeed(`Revoked ${name}`);\n  } catch (error) {\n    spinner.fail(`Failed to revoke ${name}`);\n    throw error;\n  }\n}\n\nexport function isDistCert(obj: { [key: string]: any }): obj is DistCert {\n  return (\n    obj.certP12 &&\n    typeof obj.certP12 === 'string' &&\n    obj.certPassword &&\n    typeof obj.certPassword === 'string' &&\n    obj.teamId &&\n    typeof obj.teamId === 'string'\n  );\n}\n\nconst APPLE_DIST_CERTS_TOO_MANY_GENERATED_ERROR = `\nYou can have only ${chalk.underline(\n  'three'\n)} Apple Distribution Certificates generated on your Apple Developer account.\nPlease revoke the old ones or reuse existing from your other apps.\nPlease remember that Apple Distribution Certificates are not application specific!\n`;\n\nexport class DistCertManager {\n  constructor(public ctx: AppleCtx) {}\n\n  async list(): Promise<DistCertInfo[]> {\n    return listDistributionCertificatesAsync(this.ctx);\n  }\n  async create(): Promise<DistCert> {\n    return createDistributionCertificateAsync(this.ctx);\n  }\n  async revoke(ids: string[]) {\n    return revokeDistributionCertificateAsync(this.ctx, ids);\n  }\n\n  format({ name, id, status, expires, created, ownerName }: DistCertInfo): string {\n    const expiresDate = _formatTimestamp(expires);\n    const createdDate = _formatTimestamp(created);\n    return `${name} (${status}) - ID: ${id} - expires: ${expiresDate} (created: ${createdDate}) - owner: ${ownerName}`;\n  }\n}\n\nfunction _formatTimestamp(timestamp: number): string {\n  return dateformat(new Date(timestamp * 1000));\n}\n"],"file":"distributionCert.js"}