{"version":3,"sources":["../../../src/commands/build/BaseBuilder.ts"],"names":["secondsToMilliseconds","seconds","BaseBuilder","getUserAsync","UserManager","ensureLoggedInAsync","constructor","projectDir","options","projectConfig","manifest","exp","updateProjectConfig","command","prepareProjectInfo","run","e","BuildError","log","error","message","process","exit","Error","commandCheckStatus","checkStatus","checkProjectConfig","isDetached","platform","oldestSupportedMajorVersion","Versions","oldestSupportedMajorVersionAsync","semver","major","sdkVersion","version","newestReleasedSdkVersionAsync","warn","chalk","bold","checkForBuildInProgress","buildStatus","Project","getBuildStatusAsync","current","releaseChannel","publicUrl","jobs","length","err","logBuildStatuses","canPurchasePriorityBuilds","numberOfRemainingPriorityBuilds","hasUnlimitedPriorityBuilds","checkStatusBeforeBuild","reuseStatus","findReusableBuildAsync","slug","owner","canReuse","underline","downloadUrl","newLine","username","getCurrentUsernameAsync","forEach","job","i","packageExtension","UrlUtils","constructBuildLogsUrl","buildId","id","undefined","hasPriorityBuilds","shouldShowUpgradeInfo","priority","status","constructTurtleStatusUrl","artifacts","url","ensureReleaseExists","publish","ids","duringBuild","release","getLatestReleaseAsync","channel","publicationId","publishedTime","wait","interval","spinner","start","result","filter","succeed","text","fail","build","expIds","bundleIdentifier","ios","opts","PLATFORMS","IOS","type","ANDROID","startBuildAsync","user","getCurrentUserAsync","kind","waitOpts","completedJob","artifactUrl","artifactId","constructArtifactUrl","addNewLineIfNone","green","ALL"],"mappings":"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","sourcesContent":["import { ExpoConfig, getConfig, ProjectConfig } from '@expo/config';\nimport { Project, RobotUser, User, UserManager, Versions } from '@expo/xdl';\nimport chalk from 'chalk';\nimport delayAsync from 'delay-async';\nimport ora from 'ora';\nimport semver from 'semver';\n\nimport log from '../../log';\nimport { getProjectOwner } from '../../projects';\nimport { action as publishAction } from '../publish';\nimport * as UrlUtils from '../utils/url';\nimport { BuilderOptions } from './BaseBuilder.types';\nimport BuildError from './BuildError';\nimport { Platform, PLATFORMS } from './constants';\n\nconst secondsToMilliseconds = (seconds: number): number => seconds * 1000;\n\nexport default class BaseBuilder {\n  protected projectConfig: ProjectConfig;\n  manifest: ExpoConfig;\n\n  async getUserAsync(): Promise<User | RobotUser> {\n    return await UserManager.ensureLoggedInAsync();\n  }\n\n  constructor(public projectDir: string, public options: BuilderOptions = {}) {\n    this.projectConfig = getConfig(this.projectDir);\n    this.manifest = this.projectConfig.exp;\n  }\n\n  protected updateProjectConfig() {\n    // Update the project config\n    this.projectConfig = getConfig(this.projectDir);\n    this.manifest = this.projectConfig.exp;\n  }\n\n  async command() {\n    try {\n      await this.prepareProjectInfo();\n      await this.run();\n    } catch (e) {\n      if (!(e instanceof BuildError)) {\n        throw e;\n      } else {\n        log.error(e.message);\n        process.exit(1);\n      }\n    }\n  }\n\n  async run(): Promise<void> {\n    throw new Error('`run()` should be overridden');\n  }\n\n  async commandCheckStatus() {\n    try {\n      await this.prepareProjectInfo();\n      await this.checkStatus();\n    } catch (e) {\n      if (!(e instanceof BuildError)) {\n        throw e;\n      } else {\n        log.error(e.message);\n        process.exit(1);\n      }\n    }\n  }\n\n  async prepareProjectInfo(): Promise<void> {\n    await this.checkProjectConfig();\n    // note: this validates if a robot user is used without \"owner\" in the manifest\n    // without this check, build/status returns \"robots not allowed\".\n    getProjectOwner(\n      // TODO: Move this since it can add delay\n      await this.getUserAsync(),\n      this.projectConfig.exp\n    );\n  }\n\n  async checkProjectConfig(): Promise<void> {\n    if (this.manifest.isDetached) {\n      log.error(`'expo build:${this.platform()}' is not supported for detached projects.`);\n      process.exit(1);\n    }\n\n    // Warn user if building a project using the next deprecated SDK version\n    const oldestSupportedMajorVersion = await Versions.oldestSupportedMajorVersionAsync();\n    if (semver.major(this.manifest.sdkVersion!) === oldestSupportedMajorVersion) {\n      const { version } = await Versions.newestReleasedSdkVersionAsync();\n      log.warn(\n        `\\nSDK${oldestSupportedMajorVersion} will be ${chalk.bold(\n          'deprecated'\n        )} next! We recommend upgrading versions, ideally to the latest (SDK${semver.major(\n          version\n        )}), so you can continue to build new binaries of your app and develop in the Expo client.\\n`\n      );\n    }\n  }\n\n  async checkForBuildInProgress() {\n    log('Checking if there is a build in progress...\\n');\n    const buildStatus = await Project.getBuildStatusAsync(this.projectDir, {\n      platform: this.platform(),\n      current: true,\n      releaseChannel: this.options.releaseChannel,\n      publicUrl: this.options.publicUrl,\n      sdkVersion: this.manifest.sdkVersion,\n    } as any);\n\n    if (buildStatus.jobs && buildStatus.jobs.length > 0) {\n      throw new BuildError('Cannot start a new build, as there is already an in-progress build.');\n    }\n  }\n\n  async checkStatus(platform: 'all' | 'ios' | 'android' = 'all'): Promise<void> {\n    log('Fetching build history...\\n');\n\n    const buildStatus = await Project.getBuildStatusAsync(this.projectDir, {\n      platform,\n      current: false,\n      releaseChannel: this.options.releaseChannel,\n    });\n\n    if ('err' in buildStatus && buildStatus.err) {\n      throw new Error('Error getting current build status for this project.');\n    }\n\n    if (!(buildStatus.jobs && buildStatus.jobs.length)) {\n      log('No currently active or previous builds for this project.');\n      return;\n    }\n\n    await this.logBuildStatuses({\n      jobs: buildStatus.jobs,\n      canPurchasePriorityBuilds: buildStatus.canPurchasePriorityBuilds,\n      numberOfRemainingPriorityBuilds: buildStatus.numberOfRemainingPriorityBuilds,\n      hasUnlimitedPriorityBuilds: buildStatus.hasUnlimitedPriorityBuilds,\n    });\n  }\n\n  async checkStatusBeforeBuild(): Promise<void> {\n    log('Checking if this build already exists...\\n');\n\n    const reuseStatus = await Project.findReusableBuildAsync(\n      this.options.releaseChannel!,\n      this.platform(),\n      this.manifest.sdkVersion!,\n      this.manifest.slug!,\n      this.manifest.owner\n    );\n    if (reuseStatus.canReuse) {\n      log.warn(`Did you know that Expo provides over-the-air updates?\nPlease see the docs (${chalk.underline(\n        'https://docs.expo.io/guides/configuring-ota-updates/'\n      )}) and check if you can use them instead of building your app binaries again.`);\n\n      log.warn(\n        `There were no new changes from the last build, you can download that build from here: ${chalk.underline(\n          reuseStatus.downloadUrl!\n        )}`\n      );\n      log.newLine();\n    }\n  }\n\n  async logBuildStatuses(buildStatus: {\n    jobs: Project.BuildJobFields[];\n    canPurchasePriorityBuilds?: boolean;\n    numberOfRemainingPriorityBuilds?: number;\n    hasUnlimitedPriorityBuilds?: boolean;\n  }) {\n    log('=================');\n    log(' Builds Statuses ');\n    log('=================\\n');\n\n    const username = this.manifest.owner\n      ? this.manifest.owner\n      : await UserManager.getCurrentUsernameAsync();\n\n    buildStatus.jobs.forEach((job, i) => {\n      let platform, packageExtension;\n      if (job.platform === 'ios') {\n        platform = 'iOS';\n        packageExtension = 'IPA';\n      } else {\n        platform = 'Android';\n        packageExtension = 'APK';\n      }\n\n      log(\n        `### ${i} | ${platform} | ${UrlUtils.constructBuildLogsUrl({\n          buildId: job.id,\n          username: username ?? undefined,\n        })} ###`\n      );\n\n      const hasPriorityBuilds =\n        (buildStatus.numberOfRemainingPriorityBuilds ?? 0) > 0 ||\n        buildStatus.hasUnlimitedPriorityBuilds;\n      const shouldShowUpgradeInfo =\n        !hasPriorityBuilds &&\n        i === 0 &&\n        job.priority === 'normal' &&\n        buildStatus.canPurchasePriorityBuilds;\n      let status;\n      switch (job.status) {\n        case 'pending':\n        case 'sent-to-queue':\n          status = `Build waiting in queue...\\nQueue length: ${chalk.underline(\n            UrlUtils.constructTurtleStatusUrl()\n          )}`;\n          if (shouldShowUpgradeInfo) {\n            status += `\\nWant to wait less? Get priority builds at ${chalk.underline(\n              'https://expo.io/settings/billing'\n            )}.`;\n          }\n          break;\n        case 'started':\n          status = 'Build started...';\n          break;\n        case 'in-progress':\n          status = 'Build in progress...';\n          if (shouldShowUpgradeInfo) {\n            status += `\\nWant to wait less? Get priority builds at ${chalk.underline(\n              'https://expo.io/settings/billing'\n            )}.`;\n          }\n          break;\n        case 'finished':\n          status = 'Build finished.';\n          if (shouldShowUpgradeInfo) {\n            status += `\\nLooks like this build could have been faster.\\nRead more about priority builds at ${chalk.underline(\n              'https://expo.io/settings/billing'\n            )}.`;\n          }\n          break;\n        case 'errored':\n          status = 'There was an error with this build.';\n          if (job.id) {\n            status += `\n\nWhen requesting support, please provide this build ID:\n\n${job.id}\n`;\n          }\n          break;\n        default:\n          status = '';\n          break;\n      }\n\n      log(status);\n      if (job.status === 'finished') {\n        if (job.artifacts) {\n          log(`${packageExtension}: ${job.artifacts.url}`);\n        } else {\n          log(`Problem getting ${packageExtension} URL. Please try to build again.`);\n        }\n      }\n      log();\n    });\n  }\n\n  async ensureReleaseExists() {\n    if (this.options.publish) {\n      const { ids, url, err } = await publishAction(this.projectDir, {\n        ...this.options,\n        duringBuild: true,\n      });\n      if (err) {\n        throw new BuildError(`No url was returned from publish. Please try again.\\n${err}`);\n      } else if (!url || url === '') {\n        throw new BuildError('No url was returned from publish. Please try again.');\n      }\n      return ids;\n    } else {\n      log('Looking for releases...');\n      const release = await Project.getLatestReleaseAsync(this.projectDir, {\n        releaseChannel: this.options.releaseChannel!,\n        platform: this.platform(),\n        owner: this.manifest.owner,\n      });\n      if (!release) {\n        throw new BuildError('No releases found. Please create one using `expo publish` first.');\n      }\n      log(\n        `Using existing release on channel \"${release.channel}\":\\n` +\n          `publicationId: ${release.publicationId}\\n  publishedTime: ${release.publishedTime}`\n      );\n      return [release.publicationId];\n    }\n  }\n\n  async wait(\n    buildId: string,\n    { interval = 30, publicUrl }: { interval?: number; publicUrl?: string } = {}\n  ): Promise<any> {\n    log(\n      `Waiting for build to complete.\\nYou can press Ctrl+C to exit. It won't cancel the build, you'll be able to monitor it at the printed URL.`\n    );\n    const spinner = ora().start();\n    let i = 0;\n    while (true) {\n      i++;\n      const result = await Project.getBuildStatusAsync(this.projectDir, {\n        current: false,\n        ...(publicUrl ? { publicUrl } : {}),\n      });\n\n      const jobs = result.jobs?.filter((job: Project.BuildJobFields) => job.id === buildId);\n      const job = jobs ? jobs[0] : null;\n      if (job) {\n        switch (job.status) {\n          case 'finished':\n            spinner.succeed('Build finished.');\n            return job;\n          case 'pending':\n          case 'sent-to-queue':\n            spinner.text = 'Build queued...';\n            break;\n          case 'started':\n          case 'in-progress':\n            spinner.text = 'Build in progress...';\n            break;\n          case 'errored':\n            spinner.fail('Build failed.');\n            throw new BuildError(`Standalone build failed!`);\n          default:\n            spinner.warn('Unknown status.');\n            throw new BuildError(`Unknown status: ${job.status} - aborting!`);\n        }\n      } else if (i > 5) {\n        spinner.warn('Unknown status.');\n        throw new BuildError(`Failed to locate build job for id \"${buildId}\"`);\n      }\n      await delayAsync(secondsToMilliseconds(interval));\n    }\n  }\n\n  async build(expIds?: string[]) {\n    const { publicUrl } = this.options;\n    const platform = this.platform();\n    const bundleIdentifier = this.manifest.ios?.bundleIdentifier;\n\n    let opts: Record<string, any> = {\n      expIds,\n      platform,\n      releaseChannel: this.options.releaseChannel,\n      ...(publicUrl ? { publicUrl } : {}),\n    };\n\n    if (platform === PLATFORMS.IOS) {\n      opts = {\n        ...opts,\n        type: this.options.type,\n        bundleIdentifier,\n      };\n    } else if (platform === PLATFORMS.ANDROID) {\n      opts = {\n        ...opts,\n        type: this.options.type,\n      };\n    }\n\n    // call out to build api here with url\n    const result = await Project.startBuildAsync(this.projectDir, opts);\n\n    const { id: buildId, priority, canPurchasePriorityBuilds } = result;\n\n    log('Build started, it may take a few minutes to complete.');\n    log(\n      `You can check the queue length at ${chalk.underline(UrlUtils.constructTurtleStatusUrl())}\\n`\n    );\n    if (priority === 'normal' && canPurchasePriorityBuilds) {\n      log(\n        'You can make this faster. üê¢\\nGet priority builds at: https://expo.io/settings/billing\\n'\n      );\n    }\n\n    const user = await UserManager.getCurrentUserAsync();\n\n    if (buildId) {\n      const url = UrlUtils.constructBuildLogsUrl({\n        buildId,\n        username: this.manifest.owner || (user?.kind === 'user' ? user.username : undefined),\n      });\n\n      log(`You can monitor the build at\\n\\n ${chalk.underline(url)}\\n`);\n    }\n\n    if (this.options.wait) {\n      const waitOpts = publicUrl ? { publicUrl } : {};\n      const completedJob = await this.wait(buildId, waitOpts);\n      const artifactUrl = completedJob.artifactId\n        ? UrlUtils.constructArtifactUrl(completedJob.artifactId)\n        : completedJob.artifacts.url;\n      log.addNewLineIfNone();\n      log(`${chalk.green('Successfully built standalone app:')} ${chalk.underline(artifactUrl)}`);\n    } else {\n      log('Alternatively, run `expo build:status` to monitor it from the command line.');\n    }\n  }\n\n  platform(): Platform {\n    return PLATFORMS.ALL;\n  }\n}\n"],"file":"BaseBuilder.js"}